<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Alchemy Effect</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           THE ALCHEMY EFFECT - Slate & Sage Theme
           ============================================ */

        :root {
            /* Slate & Sage Palette */
            --bg-dark: #1a1d23;
            --bg-card: #242830;
            --bg-card-hover: #2a2f38;
            --border: #353b45;
            --border-light: #454c58;

            /* Text */
            --text-primary: #e8ecf2;
            --text-secondary: #9aa3b0;
            --text-muted: #6b7280;

            /* Matte Colors */
            --sage-green: #6b8f71;
            --sage-green-bg: rgba(107, 143, 113, 0.15);
            --dusty-rose: #a65d5d;
            --dusty-rose-bg: rgba(166, 93, 93, 0.15);
            --steel-blue: #8fa8bf;
            --steel-blue-bg: rgba(143, 168, 191, 0.15);
            --amber: #c9a962;
            --amber-bg: rgba(201, 169, 98, 0.15);

            /* Status */
            --active: #6b8f71;
            --inactive: #6b7280;
            --warning: #c9a962;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ============================================
           HEADER
           ============================================ */

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 28px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--amber);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .bot-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bot-status.active {
            background: var(--sage-green-bg);
            border: 1px solid var(--sage-green);
            color: var(--sage-green);
        }

        .bot-status.inactive {
            background: var(--dusty-rose-bg);
            border: 1px solid var(--dusty-rose);
            color: var(--dusty-rose);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .bot-controls {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
        }

        .btn-primary {
            background: var(--sage-green);
            border-color: var(--sage-green);
            color: white;
        }

        .btn-primary:hover {
            background: #5a7e60;
        }

        .btn-danger {
            background: var(--dusty-rose);
            border-color: var(--dusty-rose);
            color: white;
        }

        /* ============================================
           NAVIGATION TABS
           ============================================ */

        .nav-tabs {
            display: flex;
            gap: 0;
            padding: 0 32px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .nav-tab {
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-tab:hover {
            color: var(--text-primary);
        }

        .nav-tab.active {
            color: var(--amber);
            border-bottom-color: var(--amber);
        }

        /* ============================================
           MAIN CONTENT
           ============================================ */

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px 32px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ============================================
           CARDS
           ============================================ */

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-link {
            font-size: 13px;
            color: var(--steel-blue);
            text-decoration: none;
            cursor: pointer;
        }

        .card-link:hover {
            text-decoration: underline;
        }

        /* ============================================
           BRAIN STATUS CARD (Top)
           ============================================ */

        .brain-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, #282d36 100%);
        }

        .brain-stats {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .brain-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--sage-green-bg);
            border-radius: 20px;
            font-size: 13px;
            color: var(--sage-green);
        }

        .brain-stat {
            text-align: center;
        }

        .brain-stat-value {
            font-size: 24px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .brain-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .brain-latest {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* ============================================
           TOP SECTION ROW (AI Cards + Scanner)
           ============================================ */

        .top-section-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .top-left-column {
            flex: 2;
            min-width: 0;
        }

        .top-left-column .card:last-child {
            margin-bottom: 0;
        }

        /* ============================================
           SCANNER CARD
           ============================================ */

        .scanner-card {
            flex: 1;
            min-width: 280px;
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 900px) {
            .top-section-row {
                flex-direction: column;
            }
            .scanner-card {
                min-width: auto;
            }
        }

        .scanner-status {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .scanner-last-scan, .scanner-budget {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .scanner-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .scanner-value {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .scanner-changes {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
            flex: 1;
        }

        .scanner-section {
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 8px;
        }

        .scanner-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .scanner-section-title.added {
            color: var(--sage-green);
        }

        .scanner-section-title.removed {
            color: var(--dusty-rose);
        }

        .scanner-stocks {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .scanner-stocks .stock-tag {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .scanner-stocks .stock-tag.added {
            background: var(--sage-green-bg);
            color: var(--sage-green);
        }

        .scanner-stocks .stock-tag.removed {
            background: var(--dusty-rose-bg);
            color: var(--dusty-rose);
        }

        .scanner-stocks .stock-tag.discovery {
            background: var(--steel-blue-bg);
            color: var(--steel-blue);
        }

        .scanner-stocks .no-data {
            color: var(--text-muted);
            font-size: 12px;
            font-style: italic;
        }

        .scanner-top-discoveries {
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 8px;
        }

        .scanner-top-discoveries .scanner-section-title {
            color: var(--amber);
        }

        .btn-small {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-small:hover {
            background: var(--steel-blue-bg);
            border-color: var(--steel-blue);
        }

        .btn-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .watchlist-count {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .watchlist-section {
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-title.owned {
            color: var(--sage-green);
        }

        .section-title.watching {
            color: var(--steel-blue);
        }

        .section-title.scan {
            color: var(--amber);
        }

        .section-count {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-card);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .stock-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 80px;
            overflow-y: auto;
        }

        .stock-list .stock-tag {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
        }

        .stock-list .stock-tag.owned {
            background: var(--sage-green-bg);
            color: var(--sage-green);
            border: 1px solid var(--sage-green);
        }

        .stock-list .stock-tag.watching {
            background: var(--steel-blue-bg);
            color: var(--steel-blue);
            border: 1px solid var(--steel-blue);
            cursor: pointer;
            transition: all 0.2s;
        }

        .stock-list .stock-tag.watching:hover {
            background: var(--dusty-rose-bg);
            color: var(--dusty-rose);
            border-color: var(--dusty-rose);
        }

        .stock-list .stock-tag.watching:hover::after {
            content: ' ‚úï';
        }

        /* Watchlist Controls */
        .watchlist-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .watchlist-input-row {
            display: flex;
            gap: 8px;
        }

        .watchlist-input-row input {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
        }

        .watchlist-input-row input:focus {
            outline: none;
            border-color: var(--steel-blue);
        }

        .watchlist-input-row input::placeholder {
            text-transform: none;
            color: var(--text-muted);
        }

        .btn-add {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--sage-green);
            background: var(--sage-green-bg);
            color: var(--sage-green);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add:hover {
            background: var(--sage-green);
            color: var(--bg-dark);
        }

        .watchlist-remove-hint {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 6px;
            text-align: center;
        }

        .scanner-footer {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .scanner-status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .btn-scan {
            width: 100%;
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--steel-blue);
            background: var(--steel-blue-bg);
            color: var(--steel-blue);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-scan:hover {
            background: var(--steel-blue);
            color: var(--bg-dark);
        }

        .btn-scan:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Scan Results Section */
        .scan-results {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .scan-results-header {
            margin-bottom: 8px;
        }

        .scan-results-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .scan-results-summary {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .scan-summary-stat {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .scan-summary-label {
            color: var(--text-muted);
        }

        .scan-summary-value {
            font-weight: 500;
            color: var(--text-primary);
        }

        .scan-results-top {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .scan-stock-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 11px;
        }

        .scan-stock-symbol {
            font-weight: 600;
            color: var(--text-primary);
        }

        .scan-stock-score {
            color: var(--amber);
            font-family: 'JetBrains Mono', monospace;
        }

        .scan-stock-tag.high-score {
            border-color: var(--sage-green);
            background: var(--sage-green-bg);
        }

        .scan-stock-tag.med-score {
            border-color: var(--amber);
            background: var(--amber-bg);
        }

        /* Scan Progress */
        .scan-progress {
            margin-top: 10px;
            text-align: center;
        }

        .scan-progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .scan-progress-bar::after {
            content: '';
            display: block;
            height: 100%;
            width: 30%;
            background: var(--steel-blue);
            animation: progressMove 1.5s infinite ease-in-out;
        }

        @keyframes progressMove {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }

        .scan-progress-text {
            font-size: 11px;
            color: var(--text-muted);
        }

        .scan-no-results {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            padding: 8px;
        }

        /* ============================================
           P&L HERO CARD (Center)
           ============================================ */

        .pnl-card {
            text-align: center;
            padding: 40px 20px;
        }

        .pnl-value {
            font-size: 56px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -2px;
        }

        .pnl-value.positive { color: var(--sage-green); }
        .pnl-value.negative { color: var(--dusty-rose); }

        .pnl-percent {
            font-size: 18px;
            font-weight: 500;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .pnl-percent.positive { color: var(--sage-green); }
        .pnl-percent.negative { color: var(--dusty-rose); }

        .sparkline-container {
            margin: 24px auto;
            max-width: 400px;
            height: 60px;
        }

        .sparkline {
            display: flex;
            align-items: flex-end;
            height: 100%;
            gap: 2px;
        }

        .sparkline-bar {
            flex: 1;
            background: var(--steel-blue);
            border-radius: 2px 2px 0 0;
            min-height: 4px;
            transition: all 0.3s;
        }

        .sparkline-bar:hover {
            background: var(--amber);
        }

        .pnl-journey {
            font-size: 14px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .pnl-journey span {
            color: var(--text-secondary);
        }

        /* ============================================
           BOTTOM ROW CARDS
           ============================================ */

        .bottom-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        /* Trending Card */
        .trending-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .trending-item:last-child {
            border-bottom: none;
        }

        .trending-symbol {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .trending-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .trending-change {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .trending-change.up { color: var(--sage-green); }

        .trending-confidence {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Yesterday Card */
        .yesterday-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .yesterday-stat:last-child {
            border-bottom: none;
        }

        .yesterday-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .yesterday-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .yesterday-value.positive { color: var(--sage-green); }
        .yesterday-value.negative { color: var(--dusty-rose); }

        /* Predicted Profit Card */
        .predicted-range {
            text-align: center;
            padding: 20px 0;
        }

        .predicted-value {
            font-size: 28px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--amber);
        }

        .predicted-meta {
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .predicted-confidence {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
        }

        .confidence-bar {
            width: 100px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--amber);
            border-radius: 3px;
        }

        /* ============================================
           BRAIN TAB (Full Page)
           ============================================ */

        .brain-section {
            margin-bottom: 32px;
        }

        .brain-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .weight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .weight-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
        }

        .weight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .weight-name {
            font-weight: 600;
            font-size: 15px;
        }

        .weight-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .weight-badge.strong {
            background: var(--sage-green-bg);
            color: var(--sage-green);
        }

        .weight-badge.weak {
            background: var(--dusty-rose-bg);
            color: var(--dusty-rose);
        }

        .weight-badge.normal {
            background: var(--steel-blue-bg);
            color: var(--steel-blue);
        }

        .weight-description {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .weight-bar-container {
            margin-bottom: 8px;
        }

        .weight-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .weight-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .weight-bar-fill.strong { background: var(--sage-green); }
        .weight-bar-fill.weak { background: var(--dusty-rose); }
        .weight-bar-fill.normal { background: var(--steel-blue); }

        .weight-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Stock Profiles */
        .stock-profile {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stock-symbol {
            font-size: 18px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .stock-predictions {
            font-size: 12px;
            color: var(--text-muted);
        }

        .stock-signals {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .stock-signal {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-dark);
            border-radius: 6px;
            font-size: 12px;
        }

        .signal-indicator {
            font-size: 10px;
        }

        .signal-indicator.up { color: var(--sage-green); }
        .signal-indicator.down { color: var(--dusty-rose); }
        .signal-indicator.neutral { color: var(--text-muted); }

        /* ============================================
           TRADES TAB
           ============================================ */

        .trades-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trades-table th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .trades-table td {
            padding: 14px 12px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .trades-table tr:hover {
            background: var(--bg-card-hover);
        }

        .trade-symbol {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .trade-action {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .trade-action.buy {
            background: var(--sage-green-bg);
            color: var(--sage-green);
        }

        .trade-action.sell {
            background: var(--dusty-rose-bg);
            color: var(--dusty-rose);
        }

        .trade-pnl {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .trade-pnl.positive { color: var(--sage-green); }
        .trade-pnl.negative { color: var(--dusty-rose); }

        /* ============================================
           AI SIGNALS FEED
           ============================================ */

        .signals-feed {
            max-height: 300px;
            overflow-y: auto;
        }

        .signal-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .signal-item:hover {
            background: var(--bg-card-hover);
        }

        .signal-item:last-child {
            border-bottom: none;
        }

        .signal-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .signal-symbol {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
        }

        .signal-action {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .signal-action.buy {
            background: var(--sage-green-bg);
            color: var(--sage-green);
        }

        .signal-action.sell {
            background: var(--dusty-rose-bg);
            color: var(--dusty-rose);
        }

        .signal-right {
            text-align: right;
        }

        .signal-confidence {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .signal-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .feed-status {
            font-size: 12px;
            color: var(--sage-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .no-signals {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        /* ============================================
           LOADING & EMPTY STATES
           ============================================ */

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--amber);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* ============================================
           RESPONSIVE
           ============================================ */

        @media (max-width: 1024px) {
            .bottom-row {
                grid-template-columns: 1fr;
            }

            .brain-stats {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
            }

            .container {
                padding: 16px;
            }

            .pnl-value {
                font-size: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <span class="logo-icon">‚öóÔ∏è</span>
            <span class="logo-text">The <span>Alchemy</span> Effect</span>
        </div>
        <div class="header-right">
            <div class="bot-status active" id="bot-status">
                <span class="status-dot"></span>
                <span id="bot-status-text">Bot Active</span>
            </div>
            <div id="trading-mode-indicator" style="padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 500; background: var(--amber-bg); color: var(--amber);">
                üß† Learning
            </div>
            <div class="bot-controls">
                <button class="btn btn-primary" onclick="controlBot('start')">Start</button>
                <button class="btn btn-danger" onclick="controlBot('stop')">Stop</button>
                <button class="btn btn-kill" onclick="activateKillSwitch()" title="Emergency stop all trading" style="background: linear-gradient(135deg, #f85149, #da3633); margin-left: 10px;">‚ö†Ô∏è KILL</button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-tabs">
        <a class="nav-tab active" data-tab="dashboard">Dashboard</a>
        <a class="nav-tab" data-tab="trades">Trades</a>
        <a class="nav-tab" data-tab="brain">Brain</a>
        <a class="nav-tab" data-tab="backtest">Backtest</a>
        <a class="nav-tab" data-tab="reports">Reports</a>
        <a class="nav-tab" data-tab="settings">Settings</a>
    </nav>

    <!-- Main Content -->
    <main class="container">

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="tab-dashboard">

            <!-- Top Row: AI Cards (2/3) + Scanner (1/3) -->
            <div class="top-section-row">
                <!-- Left Column: AI Live Signals + Brain Status -->
                <div class="top-left-column">
                    <!-- AI Live Feed -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <span class="card-title">ü§ñ AI Live Signals</span>
                            <span class="feed-status" id="feed-status">‚óè Live</span>
                        </div>
                        <div id="ai-signals-feed" class="signals-feed">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                Loading AI signals...
                            </div>
                        </div>
                    </div>

                    <!-- Brain Status Card -->
                    <div class="card brain-card">
                        <div class="card-header">
                            <span class="card-title">üß† AI Brain Status</span>
                            <a class="card-link" onclick="switchTab('brain')">View Details ‚Üí</a>
                        </div>
                        <div class="brain-stats">
                            <div class="brain-status-indicator">
                                <span class="status-dot"></span>
                                Learning Active
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="brain-accuracy">--</div>
                                <div class="brain-stat-label">Accuracy</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="brain-predictions">--</div>
                                <div class="brain-stat-label">Predictions</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="brain-correct">--</div>
                                <div class="brain-stat-label">Correct</div>
                            </div>
                        </div>
                        <div class="brain-latest" id="brain-latest">
                            Loading latest activity...
                        </div>
                    </div>
                </div>

                <!-- Right Column: Watch List -->
            <div class="card scanner-card">
                <div class="card-header">
                    <span class="card-title">üìã Watch List</span>
                </div>

                <!-- Stocks Owned -->
                <div class="watchlist-section">
                    <div class="section-header">
                        <span class="section-title owned">üí∞ Stocks Owned</span>
                        <span class="section-count" id="owned-count">0</span>
                    </div>
                    <div class="stock-list" id="stocks-owned">
                        <span class="no-data">No positions</span>
                    </div>
                </div>

                <!-- Stocks Being Watched -->
                <div class="watchlist-section">
                    <div class="section-header">
                        <span class="section-title watching">üëÅ Watching</span>
                        <span class="section-count" id="watching-count">0</span>
                    </div>
                    <div class="stock-list" id="stocks-watching">
                        <span class="no-data">No stocks being watched</span>
                    </div>
                    <!-- Manual Add/Remove -->
                    <div class="watchlist-controls">
                        <div class="watchlist-input-row">
                            <input type="text" id="watchlist-input" placeholder="Enter symbol (e.g. AAPL)" maxlength="5" onkeypress="if(event.key==='Enter')addToWatchlist()" />
                            <button class="btn-add" onclick="addToWatchlist()">+ Add</button>
                        </div>
                        <div class="watchlist-remove-hint">Click a stock tag above to remove it</div>
                    </div>
                </div>

                <!-- Last Scan Results -->
                <div class="scan-results" id="scan-results" style="display: none;">
                    <div class="section-header">
                        <span class="section-title scan">üìä Last Scan Results</span>
                    </div>
                    <div class="scan-results-summary" id="scan-summary">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div class="scan-results-top" id="scan-top-stocks">
                        <!-- Top stocks from scan -->
                    </div>
                </div>

                <!-- Scan Section at Bottom -->
                <div class="scanner-footer">
                    <div class="scanner-status-row">
                        <span class="scanner-label">Last Scan:</span>
                        <span class="scanner-value" id="scanner-last-time">Never</span>
                    </div>
                    <button class="btn-scan" onclick="runScan()">üîç Scan for Stocks</button>
                    <div class="scan-progress" id="scan-progress" style="display: none;">
                        <div class="scan-progress-bar"></div>
                        <span class="scan-progress-text" id="scan-progress-text">Scanning...</span>
                    </div>
                </div>
            </div>
            </div><!-- End top-section-row -->

            <!-- P&L Hero Card (Center) -->
            <div class="card pnl-card">
                <div class="pnl-value positive" id="pnl-value">$0.00</div>
                <div class="pnl-percent positive" id="pnl-percent">
                    <span>‚ñ≤</span>
                    <span>0.00% today</span>
                </div>
                <div class="sparkline-container">
                    <div class="sparkline" id="sparkline"></div>
                </div>
                <div class="pnl-journey">
                    <span id="initial-capital">$100,000</span> ‚Üí <span id="current-value">$100,000</span>
                </div>
                <!-- Risk Status -->
                <div id="risk-status" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-muted);">
                    Loading risk status...
                </div>
            </div>

            <!-- Bottom Row -->
            <div class="bottom-row">

                <!-- Trending Up Card -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìà Trending Up</span>
                    </div>
                    <div id="trending-list">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Yesterday Summary Card -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìã Yesterday</span>
                    </div>
                    <div id="yesterday-summary">
                        <div class="yesterday-stat">
                            <span class="yesterday-label">P&L</span>
                            <span class="yesterday-value" id="yesterday-pnl">--</span>
                        </div>
                        <div class="yesterday-stat">
                            <span class="yesterday-label">Trades</span>
                            <span class="yesterday-value" id="yesterday-trades">--</span>
                        </div>
                        <div class="yesterday-stat">
                            <span class="yesterday-label">Win Rate</span>
                            <span class="yesterday-value" id="yesterday-winrate">--</span>
                        </div>
                        <div class="yesterday-stat">
                            <span class="yesterday-label">Best Trade</span>
                            <span class="yesterday-value positive" id="yesterday-best">--</span>
                        </div>
                    </div>
                </div>

                <!-- Predicted Profit Card -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üéØ Predicted Profit</span>
                    </div>
                    <div class="predicted-range">
                        <div class="predicted-value" id="predicted-range">$0 ‚Äì $0</div>
                        <div class="predicted-meta">
                            <span id="predicted-signals">0</span> open signals
                        </div>
                        <div class="predicted-confidence">
                            <span id="predicted-conf-text">0%</span> avg confidence
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="predicted-conf-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trades Tab -->
        <div class="tab-content" id="tab-trades">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Recent Trades</span>
                </div>
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Action</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>P&L</th>
                            <th>Strategy</th>
                        </tr>
                    </thead>
                    <tbody id="trades-body">
                        <tr>
                            <td colspan="7" class="loading">
                                <div class="loading-spinner"></div>
                                Loading trades...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Brain Tab -->
        <div class="tab-content" id="tab-brain">

            <!-- SimpleTrader Summary -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">ü§ñ SimpleTrader Summary</span>
                </div>
                <div class="brain-stats" style="justify-content: flex-start;">
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-detail-accuracy">--</div>
                        <div class="brain-stat-label">Win Rate</div>
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-detail-total">--</div>
                        <div class="brain-stat-label">Total Trades</div>
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-detail-correct">--</div>
                        <div class="brain-stat-label">Winners</div>
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-detail-wrong">--</div>
                        <div class="brain-stat-label">Losers</div>
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-detail-pnl">--</div>
                        <div class="brain-stat-label">Total P&L</div>
                    </div>
                </div>
            </div>

            <!-- Strategy Assignments -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìã Strategy Assignments</span>
                    <span style="color: var(--text-muted); font-size: 12px;">What SimpleTrader assigned each stock</span>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border); text-align: left;">
                                <th style="padding: 12px 8px; color: var(--text-muted);">Symbol</th>
                                <th style="padding: 12px 8px; color: var(--text-muted);">Strategy</th>
                                <th style="padding: 12px 8px; color: var(--text-muted);">Buy Rule</th>
                                <th style="padding: 12px 8px; color: var(--text-muted);">Sell Rule</th>
                                <th style="padding: 12px 8px; color: var(--text-muted);">Safety</th>
                                <th style="padding: 12px 8px; color: var(--text-muted);">Position</th>
                                <th style="padding: 12px 8px; color: var(--text-muted);">Calibrated</th>
                            </tr>
                        </thead>
                        <tbody id="strategy-assignments-table">
                            <tr><td colspan="7" style="padding: 20px; text-align: center; color: var(--text-muted);">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- RL Shadow Card - The Kid with the Coloring Book -->
            <div class="card" style="border-left: 4px solid var(--amber);">
                <div class="card-header">
                    <span class="card-title">üé® RL Shadow (The Kid's Coloring Book)</span>
                    <span style="color: var(--text-muted); font-size: 12px;">Watching & learning, NO influence on trading</span>
                </div>
                <div style="padding: 0 20px 10px 20px;">
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px; font-style: italic;">
                        The RL model watches alongside SimpleTrader like a kid with a coloring book at work.
                        It makes recommendations but we ignore them (for now). Someday it might grow up.
                    </p>
                </div>
                <div class="brain-stats" style="justify-content: flex-start; padding: 0 20px 15px 20px;">
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="rl-models-loaded">--</div>
                        <div class="brain-stat-label">Models Loaded</div>
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="rl-total-signals">--</div>
                        <div class="brain-stat-label">Signals Observed</div>
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="rl-agreement-rate">--</div>
                        <div class="brain-stat-label">Agreement Rate</div>
                    </div>
                </div>
                <div style="padding: 0 20px 20px 20px;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">What RL is "coloring" right now:</div>
                    <div id="rl-recommendations" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">
                        <div style="padding: 15px; background: var(--bg-dark); border-radius: 8px; text-align: center; color: var(--text-muted);">
                            Loading RL recommendations...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strategy Distribution -->
            <div class="brain-section">
                <div class="brain-section-title">üìä Strategy Distribution</div>
                <div class="weight-grid" id="global-weights">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Backtest Tab -->
        <div class="tab-content" id="tab-backtest">
            <!-- Backtest Configuration -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üß™ Run Backtest</span>
                </div>
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">Symbol</label>
                            <input type="text" id="backtest-symbol" placeholder="AAPL"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">Start Date</label>
                            <input type="date" id="backtest-start"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">End Date</label>
                            <input type="date" id="backtest-end"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">Strategy</label>
                            <select id="backtest-strategy"
                                    style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                                <option value="auto">Auto-Select Best Strategy</option>
                                <option value="RSI 30/70">RSI 30/70</option>
                                <option value="RSI 40/70">RSI 40/70</option>
                                <option value="MACD Cross">MACD Cross</option>
                                <option value="Bollinger 20/80">Bollinger 20/80</option>
                                <option value="Bollinger Mean Rev">Bollinger Mean Reversion</option>
                                <option value="Volume Spike">Volume Spike</option>
                                <option value="Mean Rev 2%">Mean Reversion 2%</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">Mode</label>
                            <select id="backtest-mode"
                                    style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                                <option value="test">Test Only (Temp DB)</option>
                                <option value="learn">Learn & Save to Main DB</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="runBacktest()" id="backtest-run-btn"
                            style="padding: 14px 32px; background: var(--sage-green); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>‚ñ∂</span> Run Backtest
                    </button>
                </div>
            </div>

            <!-- Backtest Progress -->
            <div class="card" id="backtest-progress-card" style="display: none;">
                <div class="card-header">
                    <span class="card-title">‚è≥ Running Backtest...</span>
                </div>
                <div style="padding: 20px;">
                    <div style="background: var(--bg-primary); border-radius: 8px; height: 20px; overflow: hidden;">
                        <div id="backtest-progress-bar" style="background: var(--sage-green); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="backtest-progress-text" style="color: var(--text-secondary); margin-top: 10px; text-align: center;">Initializing...</p>
                </div>
            </div>

            <!-- Backtest Results -->
            <div class="card" id="backtest-results-card" style="display: none;">
                <div class="card-header">
                    <span class="card-title">üìä Backtest Results</span>
                </div>
                <div style="padding: 20px;">
                    <!-- Trading P&L Results -->
                    <div style="margin-bottom: 30px; padding: 20px; background: var(--bg-dark); border-radius: 12px; border-left: 4px solid var(--sage-green);">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">üí∞ Trading Performance (Simulated)</h4>
                        <div class="brain-stats" style="justify-content: flex-start; flex-wrap: wrap; gap: 25px;">
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-symbol">--</div>
                                <div class="brain-stat-label">Symbol</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-initial">--</div>
                                <div class="brain-stat-label">Initial Capital</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-final">--</div>
                                <div class="brain-stat-label">Final Equity</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-pnl">--</div>
                                <div class="brain-stat-label">Total P&L</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-pnl-pct">--</div>
                                <div class="brain-stat-label">Return %</div>
                            </div>
                        </div>
                        <div class="brain-stats" style="justify-content: flex-start; flex-wrap: wrap; gap: 25px; margin-top: 20px;">
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-trades">--</div>
                                <div class="brain-stat-label">Total Trades</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-winrate">--</div>
                                <div class="brain-stat-label">Win Rate</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-pf">--</div>
                                <div class="brain-stat-label">Profit Factor</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-drawdown">--</div>
                                <div class="brain-stat-label">Max Drawdown</div>
                            </div>
                        </div>
                    </div>

                    <!-- Prediction Accuracy -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">üéØ Prediction Accuracy</h4>
                        <div class="brain-stats" style="justify-content: flex-start; flex-wrap: wrap; gap: 25px;">
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-predictions">--</div>
                                <div class="brain-stat-label">Total Predictions</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value positive" id="backtest-result-accuracy">--</div>
                                <div class="brain-stat-label">Overall Accuracy</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-1h">--</div>
                                <div class="brain-stat-label">1-Hour Accuracy</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-eod">--</div>
                                <div class="brain-stat-label">End-of-Day Accuracy</div>
                            </div>
                            <div class="brain-stat">
                                <div class="brain-stat-value" id="backtest-result-nextday">--</div>
                                <div class="brain-stat-label">Next-Day Accuracy</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Trades -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">üìã Recent Trades</h4>
                        <div id="backtest-trades-list" style="max-height: 300px; overflow-y: auto;">
                            <p style="color: var(--text-muted);">No trades executed.</p>
                        </div>
                    </div>

                    <!-- Top Features -->
                    <div style="margin-top: 30px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">üß† Top Performing Features</h4>
                        <div id="backtest-top-features" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        </div>
                    </div>

                    <!-- Decision Log Section (integrated from Reports) -->
                    <div id="backtest-decision-section" style="display: none; margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">üìú Decision Log (Every Bar)</h4>

                        <!-- Buy/Sell Rules -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div style="background: var(--bg-dark); padding: 15px; border-radius: 8px;">
                                <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">Buy Rule</div>
                                <div id="backtest-buy-rule" style="color: var(--sage-green); font-size: 14px;">--</div>
                            </div>
                            <div style="background: var(--bg-dark); padding: 15px; border-radius: 8px;">
                                <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">Sell Rule</div>
                                <div id="backtest-sell-rule" style="color: var(--dusty-rose); font-size: 14px;">--</div>
                            </div>
                        </div>

                        <!-- Filter Controls -->
                        <div style="padding: 15px; background: var(--bg-dark); border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                <span style="color: var(--text-secondary); font-size: 13px;">Show:</span>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; color: var(--text-primary); font-size: 13px;">
                                    <input type="checkbox" id="backtest-filter-buy" checked onchange="filterBacktestDecisionLog()">
                                    <span style="color: var(--sage-green);">BUY</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; color: var(--text-primary); font-size: 13px;">
                                    <input type="checkbox" id="backtest-filter-sell" checked onchange="filterBacktestDecisionLog()">
                                    <span style="color: var(--dusty-rose);">SELL</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; color: var(--text-primary); font-size: 13px;">
                                    <input type="checkbox" id="backtest-filter-hold" onchange="filterBacktestDecisionLog()">
                                    <span style="color: var(--text-muted);">HOLD</span>
                                </label>
                                <span style="color: var(--text-muted); font-size: 12px; margin-left: auto;" id="backtest-decision-count">0 decisions shown</span>
                            </div>
                        </div>

                        <!-- Decision Log Container -->
                        <div id="backtest-decision-log-container" style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
                            <!-- Decision entries will be inserted here -->
                        </div>
                    </div>

                    <!-- Executed Trades Section -->
                    <div id="backtest-executed-trades-section" style="display: none; margin-top: 25px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px; border-top: 1px solid var(--border); padding-top: 20px;">üí∞ Executed Trades</h4>
                        <div id="backtest-executed-trades-container" style="max-height: 400px; overflow-y: auto;">
                            <!-- Trade entries will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backtest History -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìú Backtest History</span>
                </div>
                <div style="padding: 20px;">
                    <div id="backtest-history">
                        <p style="color: var(--text-muted); text-align: center;">Run a backtest to see results here.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-content" id="tab-reports">
            <!-- Daily Performance Report -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìä Daily Performance Report</span>
                    <button onclick="generateDailyReport()" style="padding: 8px 16px; background: var(--sage-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        Generate Report
                    </button>
                </div>
                <div style="padding: 20px;">
                    <div id="daily-report-content">
                        <p style="color: var(--text-muted); text-align: center;">Click "Generate Report" to create today's performance summary.</p>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìà Performance Metrics</span>
                    <select id="report-period" style="padding: 8px 12px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px;">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div style="padding: 20px;">
                    <div class="brain-stats" style="justify-content: flex-start; flex-wrap: wrap; gap: 30px;">
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-total-pnl">--</div>
                            <div class="brain-stat-label">Total P&L</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-total-trades">--</div>
                            <div class="brain-stat-label">Total Trades</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-win-rate">--</div>
                            <div class="brain-stat-label">Win Rate</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-avg-win">--</div>
                            <div class="brain-stat-label">Avg Win</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-avg-loss">--</div>
                            <div class="brain-stat-label">Avg Loss</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-profit-factor">--</div>
                            <div class="brain-stat-label">Profit Factor</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RL Shadow Report -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üé® RL Shadow Report</span>
                    <span style="color: var(--text-muted); font-size: 12px;">AI models watching & learning</span>
                </div>
                <div style="padding: 20px;">
                    <div class="brain-stats" style="justify-content: flex-start; flex-wrap: wrap; gap: 30px;">
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-predictions-total">--</div>
                            <div class="brain-stat-label">Models Loaded</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-predictions-correct">--</div>
                            <div class="brain-stat-label">Current Signals</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-accuracy-overall">--</div>
                            <div class="brain-stat-label">Agreement Rate</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-accuracy-1h">--</div>
                            <div class="brain-stat-label">Signals Observed</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-accuracy-eod">--</div>
                            <div class="brain-stat-label">Agreements</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade Log Export -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìã Export Data</span>
                </div>
                <div style="padding: 20px;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button onclick="exportTrades('csv')" style="padding: 12px 24px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px;">
                            üì• Trades CSV
                        </button>
                        <button onclick="exportTrades('json')" style="padding: 12px 24px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px;">
                            üì• Trades JSON
                        </button>
                        <button onclick="exportPredictions()" style="padding: 12px 24px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px;">
                            üì• RL Shadow Data
                        </button>
                    </div>
                    <p style="color: var(--text-muted); margin-top: 15px; font-size: 13px;">
                        Trade logs are also saved automatically to <code style="background: var(--bg-dark); padding: 2px 6px; border-radius: 4px;">trade_logs/</code> directory.
                    </p>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üîç Recent Trading Activity</span>
                    <button onclick="loadRecentLogs()" style="padding: 8px 16px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 14px;">
                        Refresh
                    </button>
                </div>
                <div style="padding: 20px;">
                    <div id="system-logs" style="background: var(--bg-dark); padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; color: var(--text-secondary);">
                        <p>Click "Refresh" to load recent activity.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="tab-settings">
            <!-- Trading Mode -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üéÆ Trading Mode</span>
                    <span id="current-mode-badge" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; background: var(--amber-bg); color: var(--amber);">Loading...</span>
                </div>
                <div style="padding: 20px;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 10px; padding: 15px 25px; background: var(--bg-dark); border-radius: 8px; cursor: pointer; border: 2px solid var(--border);" class="mode-option" data-mode="learning">
                            <input type="radio" name="trading-mode" value="learning" style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 600; color: var(--amber);">üß† Learning Mode</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">AI learns from predictions, no trades</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; padding: 15px 25px; background: var(--bg-dark); border-radius: 8px; cursor: pointer; border: 2px solid var(--border);" class="mode-option" data-mode="paper">
                            <input type="radio" name="trading-mode" value="paper" style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 600; color: var(--steel-blue);">üìù Paper Trading</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Real trades on Alpaca paper account</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; padding: 15px 25px; background: var(--bg-dark); border-radius: 8px; cursor: pointer; border: 2px solid var(--border);" class="mode-option" data-mode="live">
                            <input type="radio" name="trading-mode" value="live" style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 600; color: var(--dusty-rose);">üí∞ Live Trading</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Real money - use with caution!</div>
                            </div>
                        </label>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="applyTradingMode()" class="btn btn-primary" style="margin-right: 10px;">
                            Apply Mode Change
                        </button>
                        <span id="mode-change-status" style="color: var(--text-muted); font-size: 13px;"></span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-top: 15px;">
                        ‚ö†Ô∏è <strong>Learning:</strong> Bot makes predictions but doesn't trade. <strong>Paper:</strong> Trades placed on Alpaca paper account. <strong>Live:</strong> Real money trades on Alpaca.
                    </p>
                </div>
            </div>

            <!-- Risk Management Settings -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üõ°Ô∏è Risk Management</span>
                </div>
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Max Position Size (% of portfolio)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-max-position" min="1" max="25" value="10"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'max-position-value', '%')">
                                <span id="max-position-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">10%</span>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Max Daily Loss (% - stops trading)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-max-daily-loss" min="1" max="10" value="5"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'max-daily-loss-value', '%')">
                                <span id="max-daily-loss-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">5%</span>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Default Stop Loss (%)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-stop-loss" min="0.5" max="5" step="0.5" value="2"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'stop-loss-value', '%')">
                                <span id="stop-loss-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">2%</span>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Max Drawdown Limit (%)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-max-drawdown" min="5" max="30" value="15"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'max-drawdown-value', '%')">
                                <span id="max-drawdown-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">15%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Parameters -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìä Trading Parameters</span>
                </div>
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Initial Capital ($)
                            </label>
                            <input type="number" id="setting-initial-capital" value="100000" min="1000" step="1000"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Default Order Type
                            </label>
                            <select id="setting-order-type"
                                    style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                                <option value="market">Market Order</option>
                                <option value="limit" selected>Limit Order</option>
                                <option value="stop_loss">Stop Loss</option>
                                <option value="stop_limit">Stop Limit</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Max Positions (Day Trading)
                            </label>
                            <input type="number" id="setting-max-positions" value="20" min="1" max="100"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Max Trades Per Day
                            </label>
                            <input type="number" id="setting-max-trades" value="1000" min="1" max="5000"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ML & AI Settings -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">ü§ñ AI & Machine Learning</span>
                </div>
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Prediction Model
                            </label>
                            <select id="setting-ml-model"
                                    style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                                <option value="ensemble" selected>Ensemble (Recommended)</option>
                                <option value="xgboost">XGBoost</option>
                                <option value="lstm">LSTM Neural Network</option>
                                <option value="random_forest">Random Forest</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Min Confidence to Trade (%)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-min-confidence" min="50" max="90" value="65"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'min-confidence-value', '%')">
                                <span id="min-confidence-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">65%</span>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Sentiment Weight (0-1)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-sentiment-weight" min="0" max="100" value="30"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'sentiment-weight-value', '%', 100)">
                                <span id="sentiment-weight-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">0.30</span>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Model Retrain Frequency
                            </label>
                            <select id="setting-retrain-freq"
                                    style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                                <option value="daily">Daily</option>
                                <option value="weekly" selected>Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Watchlist Management -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìã Watchlist</span>
                </div>
                <div style="padding: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                            Symbols (comma-separated)
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="setting-watchlist" placeholder="AAPL, MSFT, GOOGL, TSLA"
                                   style="flex: 1; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                            <button onclick="addToSettingsWatchlist()" style="padding: 12px 20px; background: var(--sage-green); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Add
                            </button>
                        </div>
                    </div>
                    <div id="watchlist-tags" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <span class="watchlist-tag" style="padding: 8px 15px; background: var(--bg-primary); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                            SPY <button onclick="removeFromSettingsWatchlist(this)" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">√ó</button>
                        </span>
                        <span class="watchlist-tag" style="padding: 8px 15px; background: var(--bg-primary); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                            QQQ <button onclick="removeFromSettingsWatchlist(this)" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">√ó</button>
                        </span>
                        <span class="watchlist-tag" style="padding: 8px 15px; background: var(--bg-primary); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                            IWM <button onclick="removeFromSettingsWatchlist(this)" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">√ó</button>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px;">
                <button onclick="resetSettings()" style="padding: 14px 28px; background: var(--card-bg); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; cursor: pointer;">
                    Reset to Defaults
                </button>
                <button onclick="saveSettings()" style="padding: 14px 28px; background: var(--sage-green); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                    üíæ Save Settings
                </button>
            </div>

            <!-- Settings Info -->
            <div class="card" style="margin-top: 20px; border-left: 3px solid var(--warm-gold);">
                <div style="padding: 20px;">
                    <p style="color: var(--text-secondary); margin: 0;">
                        <strong style="color: var(--warm-gold);">‚ÑπÔ∏è Note:</strong> Settings are saved to your browser's local storage and applied on next bot start.
                        For permanent changes, edit <code style="background: var(--bg-primary); padding: 2px 6px; border-radius: 4px;">config/config.yaml</code> directly.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ============================================
        // THE ALCHEMY EFFECT - JavaScript
        // ============================================

        const API_BASE = '';

        // Tab Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                switchTab(tabId);
            });
        });

        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`.nav-tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // Load tab-specific data
            if (tabId === 'brain') loadBrainDetails();
            if (tabId === 'trades') loadTrades();
            if (tabId === 'reports') {
                generateDailyReport();
                loadRecentLogs();
            }
        }

        // API Calls
        async function api(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                return null;
            }
        }

        async function controlBot(action) {
            try {
                // Use SimpleTrader endpoints for bot control
                let endpoint = '';
                if (action === 'start') {
                    endpoint = '/api/simple-trader/start';
                } else if (action === 'stop') {
                    endpoint = '/api/simple-trader/stop';
                } else {
                    // Fallback to old endpoint for other actions
                    endpoint = '/api/bot/control';
                }

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: action !== 'start' && action !== 'stop' ? JSON.stringify({ action }) : '{}'
                });
                const data = await response.json();
                if (data.success) {
                    loadStatus();
                    loadSignals(); // Also refresh signals after bot state change
                }
            } catch (error) {
                console.error('Control error:', error);
            }
        }

        // Load Dashboard Data
        async function loadDashboard() {
            await Promise.all([
                loadStatus(),
                loadBrain(),
                loadPnL(),
                loadTrending(),
                loadYesterday(),
                loadPredicted(),
                loadSignals(),
                loadScanner(),
                loadScanResults()
            ]);
        }

        // Watch List / Scanner Functions
        async function loadScanner() {
            try {
                // Load positions (stocks owned)
                const ownedEl = document.getElementById('stocks-owned');
                const ownedCountEl = document.getElementById('owned-count');
                const portfolioData = await api('/api/portfolio');

                let ownedSymbols = [];
                if (portfolioData && portfolioData.positions) {
                    ownedSymbols = portfolioData.positions.map(p => p.symbol);
                }

                ownedCountEl.textContent = ownedSymbols.length;
                if (ownedSymbols.length > 0) {
                    ownedEl.innerHTML = ownedSymbols.map(s =>
                        `<span class="stock-tag owned">${s}</span>`
                    ).join('');
                } else {
                    ownedEl.innerHTML = '<span class="no-data">No positions</span>';
                }

                // Load watchlist (stocks being watched)
                const watchingEl = document.getElementById('stocks-watching');
                const watchingCountEl = document.getElementById('watching-count');
                const traderStatus = await api('/api/simple-trader/status');

                let watchingSymbols = [];
                if (traderStatus && traderStatus.symbols) {
                    // Watching = watchlist minus owned
                    watchingSymbols = traderStatus.symbols.filter(s => !ownedSymbols.includes(s));
                }

                watchingCountEl.textContent = watchingSymbols.length;
                if (watchingSymbols.length > 0) {
                    watchingEl.innerHTML = watchingSymbols.map(s =>
                        `<span class="stock-tag watching" onclick="removeFromWatchlist('${s}')">${s}</span>`
                    ).join('');
                } else {
                    watchingEl.innerHTML = '<span class="no-data">No stocks being watched</span>';
                }

                // Load scanner status for last scan time
                const status = await api('/api/scanner/status');
                if (status) {
                    const lastTimeEl = document.getElementById('scanner-last-time');
                    if (status.last_scan_time) {
                        const scanDate = new Date(status.last_scan_time);
                        lastTimeEl.textContent = scanDate.toLocaleString();
                    } else {
                        lastTimeEl.textContent = 'Never';
                    }
                }
            } catch (e) {
                console.error('Error loading watchlist:', e);
            }
        }

        async function addToWatchlist() {
            const input = document.getElementById('watchlist-input');
            const symbol = input.value.trim().toUpperCase();

            if (!symbol) return;

            try {
                const result = await fetch('/api/scanner/add-stock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol })
                });
                const data = await result.json();

                if (data.success) {
                    input.value = '';
                    await loadScanner();
                } else {
                    alert('Failed to add: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Add error:', e);
                alert('Error adding stock');
            }
        }

        async function removeFromWatchlist(symbol) {
            if (!confirm(`Remove ${symbol} from watchlist?`)) return;

            try {
                const result = await fetch('/api/scanner/remove-stock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol })
                });
                const data = await result.json();

                if (data.success) {
                    await loadScanner();
                } else {
                    alert('Failed to remove: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Remove error:', e);
                alert('Error removing stock');
            }
        }

        async function runScan() {
            const btn = event.target;
            const progressEl = document.getElementById('scan-progress');
            const progressText = document.getElementById('scan-progress-text');

            btn.disabled = true;
            btn.style.display = 'none';
            progressEl.style.display = 'block';
            progressText.textContent = 'Starting scan...';

            try {
                const result = await fetch('/api/scanner/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ batch_size: 50, fetch_news: true })
                });
                const data = await result.json();

                if (data.success) {
                    progressText.textContent = 'Scanning stocks...';

                    // Poll for completion every 3 seconds
                    let attempts = 0;
                    const maxAttempts = 40; // Up to 2 minutes

                    const pollInterval = setInterval(async () => {
                        attempts++;
                        progressText.textContent = `Scanning... (${attempts * 3}s)`;

                        try {
                            const status = await api('/api/scanner/status');
                            if (status && !status.scan_in_progress) {
                                // Scan complete
                                clearInterval(pollInterval);
                                progressText.textContent = 'Scan complete! Loading results...';

                                // Load results
                                await loadScanner();
                                await loadScanResults();

                                // Reset button
                                progressEl.style.display = 'none';
                                btn.style.display = 'block';
                                btn.textContent = 'üîç Scan for Stocks';
                                btn.disabled = false;
                            } else if (attempts >= maxAttempts) {
                                clearInterval(pollInterval);
                                progressEl.style.display = 'none';
                                btn.style.display = 'block';
                                btn.textContent = 'Scan Timeout';
                                btn.disabled = false;
                                setTimeout(() => {
                                    btn.textContent = 'üîç Scan for Stocks';
                                }, 3000);
                            }
                        } catch (e) {
                            console.error('Poll error:', e);
                        }
                    }, 3000);

                } else {
                    progressEl.style.display = 'none';
                    btn.style.display = 'block';
                    btn.textContent = 'Error: ' + (data.error || 'Unknown');
                    btn.disabled = false;
                    setTimeout(() => {
                        btn.textContent = 'üîç Scan for Stocks';
                    }, 3000);
                }
            } catch (e) {
                console.error('Scan error:', e);
                progressEl.style.display = 'none';
                btn.style.display = 'block';
                btn.textContent = 'Error';
                btn.disabled = false;
                setTimeout(() => {
                    btn.textContent = 'üîç Scan for Stocks';
                }, 2000);
            }
        }

        async function loadScanResults() {
            try {
                const results = await api('/api/scanner/results?min_score=0&limit=10');
                const resultsEl = document.getElementById('scan-results');
                const summaryEl = document.getElementById('scan-summary');
                const topStocksEl = document.getElementById('scan-top-stocks');

                if (results && results.results && results.results.length > 0) {
                    resultsEl.style.display = 'block';

                    const topScore = Math.max(...results.results.map(r => r.composite_score || 0));
                    const autoAddThreshold = 60;
                    const qualifyingStocks = results.results.filter(r => (r.composite_score || 0) >= autoAddThreshold).length;

                    summaryEl.innerHTML = `
                        <div class="scan-summary-stat">
                            <span class="scan-summary-label">Stocks Scanned</span>
                            <span class="scan-summary-value">${results.total_scanned || results.results.length}</span>
                        </div>
                        <div class="scan-summary-stat">
                            <span class="scan-summary-label">Top Score</span>
                            <span class="scan-summary-value">${topScore.toFixed(1)}</span>
                        </div>
                        <div class="scan-summary-stat">
                            <span class="scan-summary-label">Auto-Add Threshold</span>
                            <span class="scan-summary-value">${autoAddThreshold}</span>
                        </div>
                        <div class="scan-summary-stat">
                            <span class="scan-summary-label">Qualifying Stocks</span>
                            <span class="scan-summary-value">${qualifyingStocks}</span>
                        </div>
                    `;

                    // Show top 5 stocks
                    const top5 = results.results.slice(0, 5);
                    topStocksEl.innerHTML = top5.map(stock => {
                        const score = stock.composite_score || 0;
                        const scoreClass = score >= 75 ? 'high-score' :
                                          score >= 60 ? 'med-score' : '';
                        return `<span class="scan-stock-tag ${scoreClass}">
                            <span class="scan-stock-symbol">${stock.symbol}</span>
                            <span class="scan-stock-score">${score.toFixed(1)}</span>
                        </span>`;
                    }).join('');

                } else {
                    resultsEl.style.display = 'none';
                }
            } catch (e) {
                console.error('Error loading scan results:', e);
            }
        }

        async function loadStatus() {
            // Try SimpleTrader status first, fallback to old API
            let data = await api('/api/simple-trader/status');

            // Also check kill switch status
            const killSwitchData = await api('/api/killswitch/status');
            const riskData = await api('/api/risk/status');

            const statusEl = document.getElementById('bot-status');
            const textEl = document.getElementById('bot-status-text');

            // Kill switch takes priority
            if (killSwitchData && killSwitchData.active) {
                statusEl.className = 'bot-status killed';
                textEl.textContent = 'KILL SWITCH ACTIVE';
                statusEl.style.background = 'linear-gradient(135deg, #f85149, #da3633)';
                window.killSwitchActive = true;
            } else if (riskData && riskData.circuit_breaker && riskData.circuit_breaker.active) {
                statusEl.className = 'bot-status circuit-breaker';
                textEl.textContent = 'Circuit Breaker: ' + (riskData.circuit_breaker.reason || 'Active');
                statusEl.style.background = 'linear-gradient(135deg, #f0b429, #d69e2e)';
                window.killSwitchActive = false;
            } else if (data && data.success) {
                window.killSwitchActive = false;
                if (data.running) {
                    statusEl.className = 'bot-status active';
                    statusEl.style.background = '';
                    textEl.textContent = 'Simple Trader Active';
                } else {
                    statusEl.className = 'bot-status inactive';
                    statusEl.style.background = '';
                    textEl.textContent = 'Simple Trader Inactive';
                }

                // Store strategies for display elsewhere
                window.simpleTraderStrategies = data.strategies || {};
            } else {
                // Fallback to old status endpoint
                data = await api('/api/status');
                if (data) {
                    if (data.bot_active) {
                        statusEl.className = 'bot-status active';
                        textEl.textContent = 'Bot Active';
                    } else {
                        statusEl.className = 'bot-status inactive';
                        textEl.textContent = 'Bot Inactive';
                    }
                }
            }

            // Update risk display if element exists
            const riskEl = document.getElementById('risk-status');
            if (riskEl && riskData) {
                riskEl.innerHTML = `
                    <div>Daily P&L: <span class="${riskData.daily_pnl >= 0 ? 'positive' : 'negative'}">${riskData.daily_pnl >= 0 ? '+' : ''}${riskData.daily_pnl_pct?.toFixed(2) || 0}%</span></div>
                    <div>Consecutive: ${riskData.consecutive_losses > 0 ? riskData.consecutive_losses + ' losses' : riskData.consecutive_wins + ' wins'}</div>
                `;
            }
        }

        // Kill Switch Controls
        async function activateKillSwitch() {
            if (!confirm('EMERGENCY: This will immediately stop ALL trading. Continue?')) return;

            try {
                const response = await fetch('/api/killswitch/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: 'Manual activation from dashboard' })
                });
                const data = await response.json();
                if (data.success) {
                    alert('Kill switch activated - all trading halted');
                    loadStatus();
                }
            } catch (e) {
                console.error('Kill switch error:', e);
                alert('Error activating kill switch');
            }
        }

        async function deactivateKillSwitch() {
            if (!confirm('Resume trading? Make sure conditions are safe.')) return;

            try {
                const response = await fetch('/api/killswitch/deactivate', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    alert('Kill switch deactivated - trading can resume');
                    loadStatus();
                }
            } catch (e) {
                console.error('Kill switch error:', e);
            }
        }

        async function resetCircuitBreaker() {
            if (!confirm('Reset circuit breaker and allow trading to resume?')) return;

            try {
                const response = await fetch('/api/risk/reset-circuit-breaker', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    alert('Circuit breaker reset');
                    loadStatus();
                }
            } catch (e) {
                console.error('Circuit breaker reset error:', e);
            }
        }

        async function loadBrain() {
            const data = await api('/api/brain');
            if (data) {
                document.getElementById('brain-accuracy').textContent = `${data.overall_accuracy?.toFixed(1) || 0}%`;
                document.getElementById('brain-predictions').textContent = data.total_predictions || 0;
                document.getElementById('brain-correct').textContent = data.correct || 0;

                // Latest activity
                if (data.global_weights && data.global_weights.length > 0) {
                    const top = data.global_weights[0];
                    document.getElementById('brain-latest').textContent =
                        `Top signal: ${top.name} (${top.weight.toFixed(2)} weight, ${top.accuracy.toFixed(0)}% accuracy)`;
                }
            }
        }

        async function loadPnL() {
            const data = await api('/api/pnl');
            if (data) {
                const pnlValue = document.getElementById('pnl-value');
                const pnlPercent = document.getElementById('pnl-percent');

                const todayPnl = data.today_pnl || 0;
                const todayPct = data.today_pnl_pct || 0;

                pnlValue.textContent = `${todayPnl >= 0 ? '+' : ''}$${Math.abs(todayPnl).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                pnlValue.className = `pnl-value ${todayPnl >= 0 ? 'positive' : 'negative'}`;

                pnlPercent.innerHTML = `<span>${todayPnl >= 0 ? '‚ñ≤' : '‚ñº'}</span><span>${Math.abs(todayPct).toFixed(2)}% today</span>`;
                pnlPercent.className = `pnl-percent ${todayPnl >= 0 ? 'positive' : 'negative'}`;

                // Journey
                document.getElementById('initial-capital').textContent = `$${(data.initial_capital || 100000).toLocaleString()}`;
                document.getElementById('current-value').textContent = `$${(data.current_value || 100000).toLocaleString()}`;

                // Sparkline
                renderSparkline(data.sparkline || []);
            }
        }

        function renderSparkline(data) {
            const container = document.getElementById('sparkline');
            if (!data.length) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">No data yet</div>';
                return;
            }

            const maxVal = Math.max(...data.map(d => Math.abs(d.cumulative || 0)), 1);

            container.innerHTML = data.map(d => {
                const height = Math.max(10, (Math.abs(d.cumulative || 0) / maxVal) * 100);
                return `<div class="sparkline-bar" style="height: ${height}%" title="${d.date}: $${d.cumulative?.toFixed(2)}"></div>`;
            }).join('');
        }

        async function loadTrending() {
            const data = await api('/api/trending');
            const container = document.getElementById('trending-list');

            if (!data || !data.trending || data.trending.length === 0) {
                container.innerHTML = '<div class="empty-state">No trending stocks</div>';
                return;
            }

            container.innerHTML = data.trending.map(t => `
                <div class="trending-item">
                    <span class="trending-symbol">${t.symbol}</span>
                    <div class="trending-meta">
                        <span class="trending-change up">‚ñ≤</span>
                        <span class="trending-confidence">üß† ${t.confidence?.toFixed(0) || 0}%</span>
                    </div>
                </div>
            `).join('');
        }

        async function loadYesterday() {
            const data = await api('/api/yesterday');
            if (data) {
                const pnl = data.pnl || 0;
                document.getElementById('yesterday-pnl').textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
                document.getElementById('yesterday-pnl').className = `yesterday-value ${pnl >= 0 ? 'positive' : 'negative'}`;

                document.getElementById('yesterday-trades').textContent = `${data.trades || 0} (${data.wins || 0}W/${data.losses || 0}L)`;
                document.getElementById('yesterday-winrate').textContent = `${(data.win_rate || 0).toFixed(0)}%`;

                if (data.best_trade) {
                    document.getElementById('yesterday-best').textContent = `${data.best_trade.symbol} +$${data.best_trade.pnl?.toFixed(2)}`;
                } else {
                    document.getElementById('yesterday-best').textContent = '--';
                }
            }
        }

        async function loadPredicted() {
            const data = await api('/api/predicted-profit');
            if (data) {
                document.getElementById('predicted-range').textContent =
                    `$${data.predicted_low?.toFixed(0) || 0} ‚Äì $${data.predicted_high?.toFixed(0) || 0}`;
                document.getElementById('predicted-signals').textContent = data.open_signals || 0;
                document.getElementById('predicted-conf-text').textContent = `${data.avg_confidence?.toFixed(0) || 0}%`;
                document.getElementById('predicted-conf-bar').style.width = `${data.avg_confidence || 0}%`;
            }
        }

        async function loadSignals() {
            const container = document.getElementById('ai-signals-feed');
            const statusEl = document.getElementById('feed-status');

            try {
                // Use SimpleTrader signals (shows strategy-based signals)
                const data = await api('/api/simple-trader/signals');

                if (!data || !data.success || !data.signals || data.signals.length === 0) {
                    container.innerHTML = `
                        <div class="no-signals">
                            <div>No active signals</div>
                            <div style="font-size: 12px; margin-top: 8px;">Simple Trader is analyzing indicators...</div>
                        </div>
                    `;
                    statusEl.textContent = '‚óè No signals';
                    statusEl.style.color = 'var(--text-muted)';
                    return;
                }

                // Filter to show only BUY/SELL signals first, then HOLD
                const actionSignals = data.signals.filter(s => s.action !== 'HOLD');
                const holdSignals = data.signals.filter(s => s.action === 'HOLD');
                const displaySignals = [...actionSignals, ...holdSignals.slice(0, 3)]; // Show action signals + top 3 holds

                container.innerHTML = displaySignals.map(signal => {
                    const actionClass = signal.action.toLowerCase() === 'buy' ? 'buy' :
                                       signal.action.toLowerCase() === 'sell' ? 'sell' : 'hold';
                    const rsi = signal.indicators?.rsi?.toFixed(0) || '--';

                    return `
                        <div class="signal-item">
                            <div class="signal-left">
                                <span class="signal-symbol">${signal.symbol}</span>
                                <span class="signal-action ${actionClass}">${signal.action}</span>
                                <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">${signal.strategy}</span>
                            </div>
                            <div class="signal-right">
                                <div class="signal-confidence" title="RSI: ${rsi}">${signal.confidence}%</div>
                                <div class="signal-time">$${signal.price?.toFixed(2) || '--'}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                const activeCount = actionSignals.length;
                statusEl.textContent = `‚óè ${activeCount} active signal${activeCount !== 1 ? 's' : ''}`;
                statusEl.style.color = activeCount > 0 ? 'var(--sage-green)' : 'var(--text-muted)';

            } catch (error) {
                console.error('Error loading signals:', error);
                // Fallback to old signals API
                try {
                    const data = await api('/api/signals');
                    if (data && data.signals && data.signals.length > 0) {
                        container.innerHTML = data.signals.map(signal => {
                            const actionClass = signal.action.toLowerCase() === 'buy' ? 'buy' : 'sell';
                            const time = new Date(signal.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                            return `
                                <div class="signal-item">
                                    <div class="signal-left">
                                        <span class="signal-symbol">${signal.symbol}</span>
                                        <span class="signal-action ${actionClass}">${signal.action}</span>
                                    </div>
                                    <div class="signal-right">
                                        <div class="signal-confidence">${signal.confidence.toFixed(0)}%</div>
                                        <div class="signal-time">${time}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        statusEl.textContent = `‚óè ${data.total} signals`;
                        statusEl.style.color = 'var(--sage-green)';
                    } else {
                        container.innerHTML = '<div class="no-signals">No active signals</div>';
                        statusEl.textContent = '‚óè Offline';
                        statusEl.style.color = 'var(--dusty-rose)';
                    }
                } catch (e2) {
                    container.innerHTML = '<div class="no-signals">Error loading signals</div>';
                    statusEl.textContent = '‚óè Offline';
                    statusEl.style.color = 'var(--dusty-rose)';
                }
            }
        }

        async function loadBrainDetails() {
            // Load SimpleTrader brain data
            const data = await api('/api/brain');
            if (!data) return;

            // Summary stats
            const totalTrades = (data.correct || 0) + (data.wrong || 0);
            document.getElementById('brain-detail-accuracy').textContent = `${data.overall_accuracy?.toFixed(1) || 0}%`;
            document.getElementById('brain-detail-total').textContent = totalTrades;
            document.getElementById('brain-detail-correct').textContent = data.correct || 0;
            document.getElementById('brain-detail-wrong').textContent = data.wrong || 0;

            // Total P&L
            const pnlEl = document.getElementById('brain-detail-pnl');
            if (pnlEl) {
                const pnl = data.total_pnl || 0;
                pnlEl.textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
                pnlEl.className = 'brain-stat-value ' + (pnl >= 0 ? 'positive' : 'negative');
            }

            // Strategy Assignments Table
            const tableBody = document.getElementById('strategy-assignments-table');
            if (data.stock_assignments && data.stock_assignments.length > 0) {
                tableBody.innerHTML = data.stock_assignments.map(s => {
                    const positionBadge = s.has_position
                        ? `<span style="background: var(--sage-green); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">OWNED</span>`
                        : `<span style="color: var(--text-muted);">-</span>`;
                    const safetyBadge = s.safety_rules
                        ? `<span style="color: var(--sage-green);">ON</span>`
                        : `<span style="color: var(--amber);">OFF</span>`;
                    const pnlText = s.unrealized_pnl !== null
                        ? `<span class="${s.unrealized_pnl >= 0 ? 'positive' : 'negative'}">${s.unrealized_pnl >= 0 ? '+' : ''}$${s.unrealized_pnl.toFixed(0)}</span>`
                        : '';

                    return `<tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 10px 8px; font-family: 'JetBrains Mono', monospace; font-weight: 600;">${s.symbol}</td>
                        <td style="padding: 10px 8px; color: var(--amber);">${s.strategy}</td>
                        <td style="padding: 10px 8px; color: var(--text-secondary); font-size: 12px;">${s.buy_rule}</td>
                        <td style="padding: 10px 8px; color: var(--text-secondary); font-size: 12px;">${s.sell_rule}</td>
                        <td style="padding: 10px 8px;">${safetyBadge}</td>
                        <td style="padding: 10px 8px;">${positionBadge} ${pnlText}</td>
                        <td style="padding: 10px 8px; color: var(--text-muted); font-size: 11px;">${s.last_calibration}</td>
                    </tr>`;
                }).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: var(--text-muted);">No strategies assigned yet</td></tr>';
            }

            // Strategy Distribution (Global Weights)
            const weightsContainer = document.getElementById('global-weights');
            if (data.global_weights && data.global_weights.length > 0) {
                weightsContainer.innerHTML = data.global_weights.map(w => `
                    <div class="weight-card">
                        <div class="weight-header">
                            <span class="weight-name">${w.name}</span>
                            <span class="weight-badge ${w.status}">${w.uses} stocks</span>
                        </div>
                        <div class="weight-description">${w.description}</div>
                        <div class="weight-bar-container">
                            <div class="weight-bar">
                                <div class="weight-bar-fill ${w.status}" style="width: ${w.weight * 100}%"></div>
                            </div>
                        </div>
                        <div class="weight-stats">
                            <span>${(w.weight * 100).toFixed(0)}% of portfolio</span>
                        </div>
                    </div>
                `).join('');
            } else {
                weightsContainer.innerHTML = '<div class="empty-state">No strategies assigned yet</div>';
            }

            // Load RL Shadow data
            loadRLShadow();
        }

        async function loadRLShadow() {
            const data = await api('/api/rl-shadow');

            // Update stats
            document.getElementById('rl-models-loaded').textContent = data?.models_loaded || 0;
            document.getElementById('rl-total-signals').textContent = data?.shadow_stats?.total_signals || 0;

            const agreementRate = data?.shadow_stats?.agreement_rate || 0;
            document.getElementById('rl-agreement-rate').textContent = `${(agreementRate * 100).toFixed(0)}%`;

            // Update recommendations
            const container = document.getElementById('rl-recommendations');
            if (data?.recommendations && data.recommendations.length > 0) {
                container.innerHTML = data.recommendations.map(r => {
                    const actionColor = r.action === 'BUY' ? 'var(--sage-green)' :
                                       r.action === 'SELL' ? 'var(--dusty-rose)' : 'var(--text-muted)';
                    const actionBg = r.action === 'BUY' ? 'rgba(139, 153, 132, 0.2)' :
                                    r.action === 'SELL' ? 'rgba(196, 154, 157, 0.2)' : 'rgba(255,255,255,0.05)';

                    const qHold = r.q_values?.HOLD?.toFixed(2) || '?';
                    const qBuy = r.q_values?.BUY?.toFixed(2) || '?';
                    const qSell = r.q_values?.SELL?.toFixed(2) || '?';

                    const positionBadge = r.has_position
                        ? `<span style="background: var(--sage-green); color: white; padding: 1px 6px; border-radius: 3px; font-size: 10px; margin-left: 6px;">OWNED</span>`
                        : '';

                    return `<div style="padding: 12px; background: ${actionBg}; border-radius: 8px; border-left: 3px solid ${actionColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 600;">${r.symbol}${positionBadge}</span>
                            <span style="color: ${actionColor}; font-weight: 600; font-size: 14px;">${r.action}</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted);">
                            Q-values: H=${qHold} | B=${qBuy} | S=${qSell}
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                            $${r.current_price?.toFixed(2) || '?'} ¬∑ ${r.train_steps?.toLocaleString() || '?'} training steps
                        </div>
                    </div>`;
                }).join('');
            } else if (data?.error) {
                container.innerHTML = `<div style="padding: 15px; background: var(--bg-dark); border-radius: 8px; text-align: center; color: var(--dusty-rose);">
                    Error: ${data.error}
                </div>`;
            } else {
                container.innerHTML = `<div style="padding: 15px; background: var(--bg-dark); border-radius: 8px; text-align: center; color: var(--text-muted);">
                    No RL models loaded. Train models with: python rl_system/rl_trader.py train --symbol AAPL
                </div>`;
            }
        }

        async function loadTrades() {
            const data = await api('/api/trades');
            const tbody = document.getElementById('trades-body');

            if (!data || !data.trades || data.trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No trades yet</td></tr>';
                return;
            }

            tbody.innerHTML = data.trades.map(t => {
                const pnlClass = t.pnl > 0 ? 'positive' : (t.pnl < 0 ? 'negative' : '');
                const pnlText = t.pnl ? `${t.pnl >= 0 ? '+' : ''}$${t.pnl.toFixed(2)}` : '--';

                return `
                    <tr>
                        <td>${new Date(t.timestamp).toLocaleString()}</td>
                        <td class="trade-symbol">${t.symbol}</td>
                        <td><span class="trade-action ${t.action}">${t.action.toUpperCase()}</span></td>
                        <td>${t.quantity.toFixed(2)}</td>
                        <td>$${t.price.toFixed(2)}</td>
                        <td class="trade-pnl ${pnlClass}">${pnlText}</td>
                        <td>${t.strategy || '--'}</td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // BACKTEST FUNCTIONS
        // ============================================

        let backtestHistory = [];
        let currentBacktestData = null; // Store current backtest data for filtering

        async function runBacktest() {
            const symbol = document.getElementById('backtest-symbol').value.trim().toUpperCase();
            const startDate = document.getElementById('backtest-start').value;
            const endDate = document.getElementById('backtest-end').value;
            const strategy = document.getElementById('backtest-strategy').value;
            const mode = document.getElementById('backtest-mode').value;

            // Validation
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }
            if (!startDate || !endDate) {
                alert('Please select start and end dates');
                return;
            }
            if (new Date(startDate) >= new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }

            // Calculate lookback days from date range
            const lookbackDays = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));

            // Show progress
            const btn = document.getElementById('backtest-run-btn');
            const progressCard = document.getElementById('backtest-progress-card');
            const resultsCard = document.getElementById('backtest-results-card');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span> Running...';
            progressCard.style.display = 'block';
            resultsCard.style.display = 'none';

            // Hide decision sections initially
            document.getElementById('backtest-decision-section').style.display = 'none';
            document.getElementById('backtest-executed-trades-section').style.display = 'none';

            // Simulate progress
            let progress = 0;
            const progressBar = document.getElementById('backtest-progress-bar');
            const progressText = document.getElementById('backtest-progress-text');

            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 10;
                    progressBar.style.width = Math.min(progress, 90) + '%';
                    progressText.textContent = `Running detailed backtest on ${symbol}... ${Math.round(progress)}%`;
                }
            }, 500);

            try {
                // Use detailed backtest endpoint for full decision logging
                const response = await fetch(`${API_BASE}/api/backtest/detailed`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        strategy: strategy === 'auto' ? null : strategy,
                        lookback_days: lookbackDays,
                        initial_capital: 10000
                    })
                });

                const data = await response.json();

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = 'Complete!';

                setTimeout(() => {
                    progressCard.style.display = 'none';

                    if (data.success) {
                        // Store for filtering and history viewing
                        currentBacktestData = data;

                        // Show results card
                        resultsCard.style.display = 'block';

                        const summary = data.summary;
                        const trades = summary.trades || {};
                        const capital = summary.capital || {};

                        // Symbol
                        document.getElementById('backtest-result-symbol').textContent = symbol;

                        // Prediction Accuracy section
                        document.getElementById('backtest-result-predictions').textContent = (summary.period?.bars_analyzed || 0).toLocaleString();
                        document.getElementById('backtest-result-accuracy').textContent = (trades.win_rate || 0).toFixed(1) + '%';
                        document.getElementById('backtest-result-1h').textContent = summary.strategy || '--';
                        document.getElementById('backtest-result-eod').textContent = (trades.total || 0) + ' trades';
                        document.getElementById('backtest-result-nextday').textContent = (trades.winners || 0) + ' wins';

                        // Trading P&L Results
                        document.getElementById('backtest-result-initial').textContent = '$' + (capital.initial || 10000).toLocaleString();
                        document.getElementById('backtest-result-final').textContent = '$' + (capital.final || 10000).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

                        const pnl = capital.pnl || 0;
                        const pnlEl = document.getElementById('backtest-result-pnl');
                        pnlEl.textContent = (pnl >= 0 ? '+$' : '-$') + Math.abs(pnl).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        pnlEl.className = 'brain-stat-value ' + (pnl >= 0 ? 'positive' : 'negative');

                        const pnlPct = capital.return_pct || 0;
                        const pnlPctEl = document.getElementById('backtest-result-pnl-pct');
                        pnlPctEl.textContent = (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%';
                        pnlPctEl.className = 'brain-stat-value ' + (pnlPct >= 0 ? 'positive' : 'negative');

                        document.getElementById('backtest-result-trades').textContent = trades.total || 0;
                        document.getElementById('backtest-result-winrate').textContent = (trades.win_rate || 0).toFixed(1) + '%';
                        document.getElementById('backtest-result-pf').textContent = trades.profit_factor ? trades.profit_factor.toFixed(2) : '--';
                        document.getElementById('backtest-result-drawdown').textContent = '--';

                        // Strategy comparison in trades list
                        const tradesContainer = document.getElementById('backtest-trades-list');
                        tradesContainer.innerHTML = `
                            <div style="background: var(--sage-green-bg); padding: 15px; border-radius: 8px;">
                                <div style="font-weight: 600; color: var(--text-primary);">üèÜ ${summary.strategy}</div>
                                <div style="color: var(--text-secondary); font-size: 13px; margin-top: 5px;">
                                    ${trades.total || 0} trades ¬∑ ${(trades.win_rate || 0).toFixed(1)}% win rate ¬∑ ${(pnlPct >= 0 ? '+' : '')}${pnlPct.toFixed(2)}% return
                                </div>
                            </div>
                        `;

                        // Top features
                        const featuresContainer = document.getElementById('backtest-top-features');
                        featuresContainer.innerHTML = `
                            <div style="background: var(--bg-primary); padding: 15px; border-radius: 8px; border-left: 3px solid var(--sage-green);">
                                <div style="font-weight: 600; color: var(--text-primary);">Strategy</div>
                                <div style="color: var(--sage-green); font-size: 18px; font-weight: bold;">${summary.strategy}</div>
                            </div>
                            <div style="background: var(--bg-primary); padding: 15px; border-radius: 8px; border-left: 3px solid var(--amber);">
                                <div style="font-weight: 600; color: var(--text-primary);">Bars Analyzed</div>
                                <div style="color: var(--amber); font-size: 18px; font-weight: bold;">${summary.period?.bars_analyzed || 0}</div>
                            </div>
                            <div style="background: var(--bg-primary); padding: 15px; border-radius: 8px; border-left: 3px solid var(--steel-blue);">
                                <div style="font-weight: 600; color: var(--text-primary);">Lookback</div>
                                <div style="color: var(--steel-blue); font-size: 18px; font-weight: bold;">${lookbackDays} days</div>
                            </div>
                        `;

                        // Show decision log section
                        document.getElementById('backtest-decision-section').style.display = 'block';
                        document.getElementById('backtest-buy-rule').textContent = summary.strategy_buy_rule || '--';
                        document.getElementById('backtest-sell-rule').textContent = summary.strategy_sell_rule || '--';

                        // Render decision log
                        filterBacktestDecisionLog();

                        // Show executed trades section
                        if (data.trades && data.trades.length > 0) {
                            document.getElementById('backtest-executed-trades-section').style.display = 'block';
                            renderBacktestExecutedTrades(data.trades);
                        }

                        // Add to history with full data for later viewing
                        backtestHistory.unshift({
                            symbol: symbol,
                            startDate: startDate,
                            endDate: endDate,
                            strategy: summary.strategy,
                            accuracy: (trades.win_rate || 0) / 100,
                            predictions: summary.period?.bars_analyzed || 0,
                            pnl: pnl,
                            pnlPct: pnlPct,
                            trades: trades.total || 0,
                            timestamp: new Date().toISOString(),
                            fullData: data // Store full data for later viewing
                        });

                        updateBacktestHistory();
                    } else {
                        alert('Backtest failed: ' + (data.error || 'Unknown error'));
                    }
                }, 500);

            } catch (error) {
                clearInterval(progressInterval);
                progressCard.style.display = 'none';
                alert('Error running backtest: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>‚ñ∂</span> Run Backtest';
            }
        }

        // Filter and render the decision log
        function filterBacktestDecisionLog() {
            if (!currentBacktestData || !currentBacktestData.decision_log) {
                document.getElementById('backtest-decision-log-container').innerHTML = '<p style="color: var(--text-muted); padding: 20px; text-align: center;">No decision data available.</p>';
                return;
            }

            const showBuy = document.getElementById('backtest-filter-buy').checked;
            const showSell = document.getElementById('backtest-filter-sell').checked;
            const showHold = document.getElementById('backtest-filter-hold').checked;

            const filteredLog = currentBacktestData.decision_log.filter(entry => {
                if (entry.decision === 'BUY' && showBuy) return true;
                if (entry.decision === 'SELL' && showSell) return true;
                if (entry.decision === 'HOLD' && showHold) return true;
                return false;
            });

            document.getElementById('backtest-decision-count').textContent = `${filteredLog.length} of ${currentBacktestData.decision_log.length} decisions shown`;
            renderBacktestDecisionLog(filteredLog);
        }

        // Render the decision log entries
        function renderBacktestDecisionLog(entries) {
            const container = document.getElementById('backtest-decision-log-container');

            if (entries.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No decisions match the current filter.</p>';
                return;
            }

            container.innerHTML = entries.map(entry => {
                const decisionColor = entry.decision === 'BUY' ? 'var(--sage-green)' :
                                     entry.decision === 'SELL' ? 'var(--dusty-rose)' : 'var(--text-muted)';
                const decisionBg = entry.decision === 'BUY' ? 'rgba(139, 171, 127, 0.1)' :
                                   entry.decision === 'SELL' ? 'rgba(199, 134, 134, 0.1)' : 'transparent';

                const timestamp = new Date(entry.timestamp);
                const timeStr = timestamp.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                // Format indicators
                const indicators = entry.indicators || {};
                const indicatorStr = `RSI: ${indicators.rsi || '--'} | MACD: ${(indicators.macd_diff > 0 ? '+' : '')}${indicators.macd_diff || '--'} | BB: ${indicators.bb_position ? (indicators.bb_position * 100).toFixed(0) + '%' : '--'} | Vol: ${indicators.volume_ratio || '--'}x`;

                // Position info
                let positionInfo = '';
                if (entry.position) {
                    const pnlColor = entry.position.current_pnl >= 0 ? 'var(--sage-green)' : 'var(--dusty-rose)';
                    positionInfo = `<div style="font-size: 11px; color: var(--text-muted); margin-top: 5px;">
                        In position @ $${entry.position.entry_price} | P&L: <span style="color: ${pnlColor}">${entry.position.current_pnl_pct >= 0 ? '+' : ''}${entry.position.current_pnl_pct?.toFixed(2) || 0}%</span>
                    </div>`;
                }

                // Trade info
                let tradeInfo = '';
                if (entry.trade) {
                    if (entry.trade.pnl !== undefined) {
                        const pnlColor = entry.trade.pnl >= 0 ? 'var(--sage-green)' : 'var(--dusty-rose)';
                        tradeInfo = `<div style="font-size: 12px; background: ${decisionBg}; padding: 8px; border-radius: 4px; margin-top: 8px;">
                            <strong>Trade:</strong> ${entry.trade.shares} shares @ $${entry.trade.price?.toFixed(2)}
                            | P&L: <span style="color: ${pnlColor}; font-weight: bold;">${entry.trade.pnl >= 0 ? '+' : ''}$${entry.trade.pnl?.toFixed(2)}</span>
                        </div>`;
                    } else {
                        tradeInfo = `<div style="font-size: 12px; background: ${decisionBg}; padding: 8px; border-radius: 4px; margin-top: 8px;">
                            <strong>Trade:</strong> Bought ${entry.trade.shares} shares @ $${entry.trade.price?.toFixed(2)}
                        </div>`;
                    }
                }

                return `
                    <div style="padding: 12px 15px; border-bottom: 1px solid var(--border); background: ${decisionBg};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <span style="color: ${decisionColor}; font-weight: 700; font-size: 14px;">${entry.decision}</span>
                                <span style="color: var(--text-muted); font-size: 12px; margin-left: 10px;">${timeStr}</span>
                                <span style="color: var(--text-primary); font-size: 13px; margin-left: 10px;">$${entry.price?.toFixed(2) || '--'}</span>
                            </div>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 13px; margin-top: 8px;">
                            ${entry.explanation || 'No explanation available'}
                        </div>
                        <div style="color: var(--text-muted); font-size: 11px; margin-top: 6px; font-family: monospace;">
                            ${indicatorStr}
                        </div>
                        ${positionInfo}
                        ${tradeInfo}
                    </div>
                `;
            }).join('');
        }

        // Render executed trades list
        function renderBacktestExecutedTrades(trades) {
            const container = document.getElementById('backtest-executed-trades-container');

            if (!trades || trades.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No trades executed.</p>';
                return;
            }

            container.innerHTML = trades.map((trade, i) => {
                const isBuy = trade.type === 'BUY';
                const color = isBuy ? 'var(--sage-green)' : 'var(--dusty-rose)';
                const pnlColor = (trade.pnl || 0) >= 0 ? 'var(--sage-green)' : 'var(--dusty-rose)';

                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border);">
                        <div>
                            <span style="color: ${color}; font-weight: 600;">${trade.type}</span>
                            <span style="color: var(--text-primary); margin-left: 10px;">${trade.shares} shares @ $${trade.price?.toFixed(2)}</span>
                        </div>
                        <div style="text-align: right;">
                            ${trade.pnl !== undefined ? `<span style="color: ${pnlColor}; font-weight: 600;">${trade.pnl >= 0 ? '+' : ''}$${trade.pnl?.toFixed(2)}</span>` : ''}
                            <div style="color: var(--text-muted); font-size: 11px;">${new Date(trade.timestamp).toLocaleDateString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View a backtest from history
        function viewBacktestFromHistory(index) {
            const bt = backtestHistory[index];
            if (!bt || !bt.fullData) {
                alert('Detailed data not available for this backtest.');
                return;
            }

            currentBacktestData = bt.fullData;

            // Show results card and scroll to it
            const resultsCard = document.getElementById('backtest-results-card');
            resultsCard.style.display = 'block';

            const summary = bt.fullData.summary;
            const trades = summary.trades || {};
            const capital = summary.capital || {};

            // Update all display elements
            document.getElementById('backtest-result-symbol').textContent = bt.symbol;
            document.getElementById('backtest-result-predictions').textContent = (summary.period?.bars_analyzed || 0).toLocaleString();
            document.getElementById('backtest-result-accuracy').textContent = (trades.win_rate || 0).toFixed(1) + '%';
            document.getElementById('backtest-result-1h').textContent = summary.strategy || '--';
            document.getElementById('backtest-result-eod').textContent = (trades.total || 0) + ' trades';
            document.getElementById('backtest-result-nextday').textContent = (trades.winners || 0) + ' wins';
            document.getElementById('backtest-result-initial').textContent = '$' + (capital.initial || 10000).toLocaleString();
            document.getElementById('backtest-result-final').textContent = '$' + (capital.final || 10000).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            const pnl = capital.pnl || 0;
            const pnlEl = document.getElementById('backtest-result-pnl');
            pnlEl.textContent = (pnl >= 0 ? '+$' : '-$') + Math.abs(pnl).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            pnlEl.className = 'brain-stat-value ' + (pnl >= 0 ? 'positive' : 'negative');

            const pnlPct = capital.return_pct || 0;
            const pnlPctEl = document.getElementById('backtest-result-pnl-pct');
            pnlPctEl.textContent = (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%';
            pnlPctEl.className = 'brain-stat-value ' + (pnlPct >= 0 ? 'positive' : 'negative');

            document.getElementById('backtest-result-trades').textContent = trades.total || 0;
            document.getElementById('backtest-result-winrate').textContent = (trades.win_rate || 0).toFixed(1) + '%';
            document.getElementById('backtest-result-pf').textContent = trades.profit_factor ? trades.profit_factor.toFixed(2) : '--';

            // Show decision log
            document.getElementById('backtest-decision-section').style.display = 'block';
            document.getElementById('backtest-buy-rule').textContent = summary.strategy_buy_rule || '--';
            document.getElementById('backtest-sell-rule').textContent = summary.strategy_sell_rule || '--';
            filterBacktestDecisionLog();

            // Show executed trades
            if (bt.fullData.trades && bt.fullData.trades.length > 0) {
                document.getElementById('backtest-executed-trades-section').style.display = 'block';
                renderBacktestExecutedTrades(bt.fullData.trades);
            }

            // Scroll to results
            resultsCard.scrollIntoView({ behavior: 'smooth' });
        }

        function updateBacktestHistory() {
            const container = document.getElementById('backtest-history');

            if (backtestHistory.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Run a backtest to see results here.</p>';
                return;
            }

            container.innerHTML = `
                <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Click a row to view detailed decision log</p>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 12px; color: var(--text-secondary);">Symbol</th>
                            <th style="text-align: left; padding: 12px; color: var(--text-secondary);">Strategy</th>
                            <th style="text-align: right; padding: 12px; color: var(--text-secondary);">Return</th>
                            <th style="text-align: right; padding: 12px; color: var(--text-secondary);">Win Rate</th>
                            <th style="text-align: right; padding: 12px; color: var(--text-secondary);">Trades</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${backtestHistory.slice(0, 10).map((bt, index) => `
                            <tr onclick="viewBacktestFromHistory(${index})" style="border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-dark)'" onmouseout="this.style.background='transparent'">
                                <td style="padding: 12px;">
                                    <div style="font-weight: 600; color: var(--text-primary);">${bt.symbol}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${bt.startDate} to ${bt.endDate}</div>
                                </td>
                                <td style="padding: 12px; color: var(--text-secondary);">${bt.strategy}</td>
                                <td style="padding: 12px; text-align: right; color: ${bt.pnlPct >= 0 ? 'var(--sage-green)' : 'var(--dusty-rose)'}; font-weight: 600;">
                                    ${bt.pnlPct >= 0 ? '+' : ''}${bt.pnlPct.toFixed(2)}%
                                </td>
                                <td style="padding: 12px; text-align: right; color: ${bt.accuracy >= 0.55 ? 'var(--sage-green)' : 'var(--dusty-rose)'}; font-weight: 600;">
                                    ${(bt.accuracy * 100).toFixed(1)}%
                                </td>
                                <td style="padding: 12px; text-align: right; color: var(--text-primary);">${bt.trades}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Initialize backtest dates to reasonable defaults
        function initBacktestDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setFullYear(startDate.getFullYear() - 2); // 2 years ago

            document.getElementById('backtest-end').value = endDate.toISOString().split('T')[0];
            document.getElementById('backtest-start').value = startDate.toISOString().split('T')[0];
        }

        // ============================================
        // TRADING MODE FUNCTIONS
        // ============================================

        async function loadCurrentTradingMode() {
            try {
                const data = await api('/api/status');
                if (data && data.trading_mode) {
                    const mode = data.trading_mode;

                    // Mode styling info
                    const modeColors = {
                        'learning': { bg: 'var(--amber-bg)', color: 'var(--amber)', text: 'üß† Learning' },
                        'paper': { bg: 'var(--steel-blue-bg)', color: 'var(--steel-blue)', text: 'üìù Paper' },
                        'live': { bg: 'var(--dusty-rose-bg)', color: 'var(--dusty-rose)', text: 'üí∞ Live' }
                    };

                    const modeInfo = modeColors[mode] || modeColors['learning'];

                    // Update header indicator
                    const headerIndicator = document.getElementById('trading-mode-indicator');
                    if (headerIndicator) {
                        headerIndicator.style.background = modeInfo.bg;
                        headerIndicator.style.color = modeInfo.color;
                        headerIndicator.textContent = modeInfo.text;
                    }

                    // Update settings page badge
                    const badge = document.getElementById('current-mode-badge');
                    if (badge) {
                        badge.style.background = modeInfo.bg;
                        badge.style.color = modeInfo.color;
                        badge.textContent = modeInfo.text;
                    }

                    // Select the radio button
                    const radio = document.querySelector(`input[name="trading-mode"][value="${mode}"]`);
                    if (radio) radio.checked = true;

                    // Highlight the selected option
                    document.querySelectorAll('.mode-option').forEach(opt => {
                        opt.style.borderColor = 'var(--border)';
                    });
                    const selectedOpt = document.querySelector(`.mode-option[data-mode="${mode}"]`);
                    if (selectedOpt) {
                        selectedOpt.style.borderColor = modeInfo.color;
                    }
                }
            } catch (error) {
                console.error('Error loading trading mode:', error);
            }
        }

        async function applyTradingMode() {
            const selectedMode = document.querySelector('input[name="trading-mode"]:checked').value;
            const statusEl = document.getElementById('mode-change-status');

            // Confirm live mode
            if (selectedMode === 'live') {
                if (!confirm('‚ö†Ô∏è WARNING: You are switching to LIVE trading mode!\n\nThis will use REAL MONEY from your Alpaca account.\n\nAre you absolutely sure?')) {
                    return;
                }
            }

            statusEl.textContent = 'Applying...';
            statusEl.style.color = 'var(--amber)';

            try {
                const response = await fetch(`${API_BASE}/api/trading/mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: selectedMode })
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.textContent = '‚úì Mode changed successfully!';
                    statusEl.style.color = 'var(--sage-green)';
                    loadCurrentTradingMode();
                    loadStatus();

                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 3000);
                } else if (data.requiresConfirmation) {
                    // Live mode needs additional confirmation
                    if (confirm(data.message + '\n\nProceed with live trading?')) {
                        const confirmResponse = await fetch(`${API_BASE}/api/trading/confirm-live`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const confirmData = await confirmResponse.json();

                        if (confirmData.success) {
                            statusEl.textContent = '‚ö†Ô∏è LIVE TRADING ENABLED';
                            statusEl.style.color = 'var(--dusty-rose)';
                            loadCurrentTradingMode();
                            loadStatus();
                        }
                    } else {
                        statusEl.textContent = 'Live mode cancelled';
                        statusEl.style.color = 'var(--text-muted)';
                    }
                } else {
                    statusEl.textContent = '‚úó ' + (data.error || 'Failed to change mode');
                    statusEl.style.color = 'var(--dusty-rose)';
                }
            } catch (error) {
                console.error('Error changing trading mode:', error);
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = 'var(--dusty-rose)';
            }
        }

        // ============================================
        // SETTINGS FUNCTIONS
        // ============================================

        const DEFAULT_SETTINGS = {
            tradingMode: 'learning',
            maxPosition: 10,
            maxDailyLoss: 5,
            stopLoss: 2,
            maxDrawdown: 15,
            initialCapital: 100000,
            orderType: 'limit',
            maxPositions: 20,
            maxTrades: 1000,
            mlModel: 'ensemble',
            minConfidence: 65,
            sentimentWeight: 30,
            retrainFreq: 'weekly',
            watchlist: ['SPY', 'QQQ', 'IWM']
        };

        function updateRangeValue(input, displayId, suffix = '', divisor = 1) {
            const value = parseFloat(input.value);
            const display = document.getElementById(displayId);
            if (divisor > 1) {
                display.textContent = (value / divisor).toFixed(2);
            } else {
                display.textContent = value + suffix;
            }
        }

        async function loadSettings() {
            // Try to load from server first
            let settings = DEFAULT_SETTINGS;
            try {
                const data = await api('/api/settings');
                if (data && data.success && data.settings) {
                    const serverSettings = data.settings;
                    settings = {
                        tradingMode: serverSettings.trading_mode || 'learning',
                        maxPosition: Math.round((serverSettings.max_position_size || 0.1) * 100),
                        maxDailyLoss: Math.round((serverSettings.max_daily_loss || 0.05) * 100),
                        stopLoss: (serverSettings.stop_loss || 0.02) * 100,
                        maxDrawdown: Math.round((serverSettings.max_drawdown || 0.15) * 100),
                        initialCapital: serverSettings.initial_capital || 100000,
                        orderType: 'limit',
                        maxPositions: serverSettings.max_positions || 20,
                        maxTrades: serverSettings.max_trades_per_day || 1000,
                        mlModel: 'ensemble',
                        minConfidence: Math.round((serverSettings.min_confidence || 0.65) * 100),
                        sentimentWeight: 30,
                        retrainFreq: 'weekly',
                        watchlist: serverSettings.watchlist || ['SPY', 'QQQ', 'IWM']
                    };
                }
            } catch (error) {
                console.error('Error loading server settings:', error);
                // Fall back to localStorage
                const saved = localStorage.getItem('alchemySettings');
                if (saved) {
                    settings = JSON.parse(saved);
                }
            }

            // Trading mode - don't set here, let loadCurrentTradingMode handle it
            const modeRadio = document.querySelector(`input[name="trading-mode"][value="${settings.tradingMode}"]`);
            if (modeRadio) modeRadio.checked = true;

            // Risk settings
            document.getElementById('setting-max-position').value = settings.maxPosition;
            updateRangeValue(document.getElementById('setting-max-position'), 'max-position-value', '%');

            document.getElementById('setting-max-daily-loss').value = settings.maxDailyLoss;
            updateRangeValue(document.getElementById('setting-max-daily-loss'), 'max-daily-loss-value', '%');

            document.getElementById('setting-stop-loss').value = settings.stopLoss;
            updateRangeValue(document.getElementById('setting-stop-loss'), 'stop-loss-value', '%');

            document.getElementById('setting-max-drawdown').value = settings.maxDrawdown;
            updateRangeValue(document.getElementById('setting-max-drawdown'), 'max-drawdown-value', '%');

            // Trading params
            document.getElementById('setting-initial-capital').value = settings.initialCapital;
            document.getElementById('setting-order-type').value = settings.orderType;
            document.getElementById('setting-max-positions').value = settings.maxPositions;
            document.getElementById('setting-max-trades').value = settings.maxTrades;

            // ML settings
            document.getElementById('setting-ml-model').value = settings.mlModel;
            document.getElementById('setting-min-confidence').value = settings.minConfidence;
            updateRangeValue(document.getElementById('setting-min-confidence'), 'min-confidence-value', '%');

            document.getElementById('setting-sentiment-weight').value = settings.sentimentWeight;
            updateRangeValue(document.getElementById('setting-sentiment-weight'), 'sentiment-weight-value', '%', 100);

            document.getElementById('setting-retrain-freq').value = settings.retrainFreq;

            // Watchlist
            renderWatchlist(settings.watchlist);
        }

        async function saveSettings() {
            // Gather settings
            const settings = {
                min_confidence: parseInt(document.getElementById('setting-min-confidence').value) / 100,  // Convert to decimal
                max_position_size: parseInt(document.getElementById('setting-max-position').value) / 100,
                max_daily_loss: parseInt(document.getElementById('setting-max-daily-loss').value) / 100,
                stop_loss: parseFloat(document.getElementById('setting-stop-loss').value) / 100,
                max_drawdown: parseInt(document.getElementById('setting-max-drawdown').value) / 100,
                initial_capital: parseInt(document.getElementById('setting-initial-capital').value),
                max_positions: parseInt(document.getElementById('setting-max-positions').value),
                max_trades_per_day: parseInt(document.getElementById('setting-max-trades').value)
            };

            try {
                // Save to server config
                const response = await fetch(`${API_BASE}/api/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.success) {
                    // Also save to localStorage for UI state
                    const localSettings = {
                        tradingMode: document.querySelector('input[name="trading-mode"]:checked')?.value || 'learning',
                        maxPosition: parseInt(document.getElementById('setting-max-position').value),
                        maxDailyLoss: parseInt(document.getElementById('setting-max-daily-loss').value),
                        stopLoss: parseFloat(document.getElementById('setting-stop-loss').value),
                        maxDrawdown: parseInt(document.getElementById('setting-max-drawdown').value),
                        initialCapital: parseInt(document.getElementById('setting-initial-capital').value),
                        orderType: document.getElementById('setting-order-type').value,
                        maxPositions: parseInt(document.getElementById('setting-max-positions').value),
                        maxTrades: parseInt(document.getElementById('setting-max-trades').value),
                        mlModel: document.getElementById('setting-ml-model').value,
                        minConfidence: parseInt(document.getElementById('setting-min-confidence').value),
                        sentimentWeight: parseInt(document.getElementById('setting-sentiment-weight').value),
                        retrainFreq: document.getElementById('setting-retrain-freq').value,
                        watchlist: getWatchlistSymbols()
                    };
                    localStorage.setItem('alchemySettings', JSON.stringify(localSettings));

                    alert('‚úÖ Settings saved to config!\n\nChanges are now active.');
                } else {
                    alert('‚ùå Failed to save settings: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                // Fallback to localStorage only
                const localSettings = {
                    tradingMode: document.querySelector('input[name="trading-mode"]:checked')?.value || 'learning',
                    maxPosition: parseInt(document.getElementById('setting-max-position').value),
                    maxDailyLoss: parseInt(document.getElementById('setting-max-daily-loss').value),
                    stopLoss: parseFloat(document.getElementById('setting-stop-loss').value),
                    maxDrawdown: parseInt(document.getElementById('setting-max-drawdown').value),
                    initialCapital: parseInt(document.getElementById('setting-initial-capital').value),
                    orderType: document.getElementById('setting-order-type').value,
                    maxPositions: parseInt(document.getElementById('setting-max-positions').value),
                    maxTrades: parseInt(document.getElementById('setting-max-trades').value),
                    mlModel: document.getElementById('setting-ml-model').value,
                    minConfidence: parseInt(document.getElementById('setting-min-confidence').value),
                    sentimentWeight: parseInt(document.getElementById('setting-sentiment-weight').value),
                    retrainFreq: document.getElementById('setting-retrain-freq').value,
                    watchlist: getWatchlistSymbols()
                };
                localStorage.setItem('alchemySettings', JSON.stringify(localSettings));
                alert('‚ö†Ô∏è Settings saved locally (server unreachable).\n\nRestart the bot to apply changes.');
            }
        }

        function resetSettings() {
            if (confirm('Reset all settings to defaults?')) {
                localStorage.removeItem('alchemySettings');
                loadSettings();
                alert('Settings reset to defaults.');
            }
        }

        function getWatchlistSymbols() {
            const tags = document.querySelectorAll('#watchlist-tags .watchlist-tag');
            return Array.from(tags).map(tag => tag.textContent.trim().replace('√ó', '').trim());
        }

        function renderWatchlist(symbols) {
            const container = document.getElementById('watchlist-tags');
            container.innerHTML = symbols.map(symbol => `
                <span class="watchlist-tag" style="padding: 8px 15px; background: var(--bg-primary); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                    ${symbol} <button onclick="removeFromSettingsWatchlist(this)" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px;">√ó</button>
                </span>
            `).join('');
        }

        function addToSettingsWatchlist() {
            const input = document.getElementById('setting-watchlist');
            const symbols = input.value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);

            if (symbols.length === 0) return;

            const current = getWatchlistSymbols();
            const updated = [...new Set([...current, ...symbols])]; // Dedupe

            renderWatchlist(updated);
            input.value = '';
        }

        function removeFromSettingsWatchlist(button) {
            button.parentElement.remove();
        }

        // Smart Auto-Refresh
        function isMarketOpen() {
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();
            const minute = now.getMinutes();

            // Monday-Friday, 9:30 AM - 4:00 PM ET (simplified)
            if (day === 0 || day === 6) return false;
            if (hour < 9 || hour > 16) return false;
            if (hour === 9 && minute < 30) return false;

            return true;
        }

        function startAutoRefresh() {
            // Refresh every 30s during market hours, 5min otherwise
            const interval = isMarketOpen() ? 30000 : 300000;

            setInterval(() => {
                loadDashboard();
            }, interval);
        }

        // ============================================
        // REPORTS TAB FUNCTIONS
        // ============================================

        async function generateDailyReport() {
            const container = document.getElementById('daily-report-content');
            container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Generating report...</p>';

            try {
                const [status, pnl, tradesData, traderStatus] = await Promise.all([
                    api('/api/status'),
                    api('/api/pnl'),
                    api('/api/trades'),
                    api('/api/simple-trader/status')
                ]);

                const trades = tradesData?.trades || [];

                const today = new Date().toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });

                const todayTrades = trades.filter(t => {
                    const tradeDate = new Date(t.timestamp).toDateString();
                    return tradeDate === new Date().toDateString();
                });

                const todayPnl = todayTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
                const wins = todayTrades.filter(t => (t.pnl || 0) > 0).length;
                const losses = todayTrades.filter(t => (t.pnl || 0) < 0).length;

                // Get stats from trader status
                const stats = traderStatus?.stats || {};
                const account = traderStatus?.account || status?.account || {};
                const positions = traderStatus?.positions || {};
                const positionCount = Object.keys(positions).length;
                const unrealizedPnl = Object.values(positions).reduce((sum, p) => sum + (p.unrealized_pnl || 0), 0);

                container.innerHTML = `
                    <div style="border-left: 4px solid var(--sage-green); padding-left: 20px;">
                        <h3 style="color: var(--text-primary); margin: 0 0 15px 0;">${today}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div>
                                <div style="color: var(--text-muted); font-size: 12px;">Today's Realized P&L</div>
                                <div style="font-size: 24px; font-weight: bold; color: ${todayPnl >= 0 ? 'var(--sage-green)' : 'var(--dusty-rose)'};">
                                    ${todayPnl >= 0 ? '+' : ''}$${todayPnl.toFixed(2)}
                                </div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 12px;">Unrealized P&L</div>
                                <div style="font-size: 24px; font-weight: bold; color: ${unrealizedPnl >= 0 ? 'var(--sage-green)' : 'var(--dusty-rose)'};">
                                    ${unrealizedPnl >= 0 ? '+' : ''}$${unrealizedPnl.toFixed(2)}
                                </div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 12px;">Today's Trades</div>
                                <div style="font-size: 24px; font-weight: bold; color: var(--text-primary);">${todayTrades.length}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 12px;">Wins / Losses</div>
                                <div style="font-size: 24px; font-weight: bold;">
                                    <span style="color: var(--sage-green);">${wins}</span> /
                                    <span style="color: var(--dusty-rose);">${losses}</span>
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div>
                                <div style="color: var(--text-muted); font-size: 12px;">Account Equity</div>
                                <div style="font-size: 20px; font-weight: bold; color: var(--text-primary);">
                                    $${(account.equity || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}
                                </div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 12px;">Open Positions</div>
                                <div style="font-size: 20px; font-weight: bold; color: var(--text-primary);">${positionCount}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 12px;">All-Time Win Rate</div>
                                <div style="font-size: 20px; font-weight: bold; color: var(--sage-green);">
                                    ${stats.trades_executed > 0 ? ((stats.winning_trades / stats.trades_executed) * 100).toFixed(1) : 0}%
                                </div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 12px;">Total P&L</div>
                                <div style="font-size: 20px; font-weight: bold; color: ${(stats.total_pnl || 0) >= 0 ? 'var(--sage-green)' : 'var(--dusty-rose)'};">
                                    ${(stats.total_pnl || 0) >= 0 ? '+' : ''}$${(stats.total_pnl || 0).toFixed(2)}
                                </div>
                            </div>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 13px;">
                            Mode: ${status?.trading_mode || 'paper'} |
                            Market: ${traderStatus?.market_open ? 'üü¢ Open' : 'üî¥ Closed'} |
                            Bot: ${traderStatus?.running ? '‚óè Running' : '‚óã Stopped'}
                        </div>
                    </div>
                `;

                // Also update the metrics
                loadReportMetrics();
            } catch (error) {
                container.innerHTML = `<p style="color: var(--dusty-rose);">Error generating report: ${error.message}</p>`;
            }
        }

        async function loadReportMetrics() {
            try {
                const tradesData = await api('/api/trades');
                const trades = tradesData?.trades || [];
                const period = document.getElementById('report-period')?.value || 'all';

                // Filter trades by period
                const now = new Date();
                let filteredTrades = trades;

                if (period === 'today') {
                    filteredTrades = trades.filter(t => new Date(t.timestamp).toDateString() === now.toDateString());
                } else if (period === 'week') {
                    const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                    filteredTrades = trades.filter(t => new Date(t.timestamp) >= weekAgo);
                } else if (period === 'month') {
                    const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                    filteredTrades = trades.filter(t => new Date(t.timestamp) >= monthAgo);
                }

                const totalPnl = filteredTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
                const wins = filteredTrades.filter(t => (t.pnl || 0) > 0);
                const losses = filteredTrades.filter(t => (t.pnl || 0) < 0);
                const winRate = filteredTrades.length > 0 ? wins.length / filteredTrades.length : 0;
                const avgWin = wins.length > 0 ? wins.reduce((s, t) => s + t.pnl, 0) / wins.length : 0;
                const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((s, t) => s + t.pnl, 0) / losses.length) : 0;
                const totalGains = wins.reduce((s, t) => s + t.pnl, 0);
                const totalLosses = Math.abs(losses.reduce((s, t) => s + t.pnl, 0));
                const profitFactor = totalLosses > 0 ? totalGains / totalLosses : totalGains > 0 ? 999 : 0;

                document.getElementById('report-total-pnl').textContent = `${totalPnl >= 0 ? '+' : ''}$${totalPnl.toFixed(2)}`;
                document.getElementById('report-total-pnl').style.color = totalPnl >= 0 ? 'var(--sage-green)' : 'var(--dusty-rose)';
                document.getElementById('report-total-trades').textContent = filteredTrades.length;
                document.getElementById('report-win-rate').textContent = `${(winRate * 100).toFixed(1)}%`;
                document.getElementById('report-avg-win').textContent = `+$${avgWin.toFixed(2)}`;
                document.getElementById('report-avg-win').style.color = 'var(--sage-green)';
                document.getElementById('report-avg-loss').textContent = `-$${avgLoss.toFixed(2)}`;
                document.getElementById('report-avg-loss').style.color = 'var(--dusty-rose)';
                document.getElementById('report-profit-factor').textContent = profitFactor >= 999 ? '‚àû' : profitFactor.toFixed(2);

            } catch (error) {
                console.error('Error loading report metrics:', error);
            }

            // Load RL Shadow stats instead of prediction accuracy
            try {
                const rlShadow = await api('/api/rl-shadow');
                if (rlShadow) {
                    const modelsLoaded = rlShadow.models_loaded || 0;
                    const totalSignals = rlShadow.shadow_stats?.total_signals || 0;
                    const agreements = rlShadow.shadow_stats?.agreements || 0;
                    const agreementRate = totalSignals > 0 ? (agreements / totalSignals) : 0;

                    // Count recommendations by action
                    const recs = rlShadow.recommendations || [];
                    const buyRecs = recs.filter(r => r.action === 'BUY').length;
                    const sellRecs = recs.filter(r => r.action === 'SELL').length;
                    const holdRecs = recs.filter(r => r.action === 'HOLD').length;

                    document.getElementById('report-predictions-total').textContent = modelsLoaded;
                    document.getElementById('report-predictions-correct').textContent = `${buyRecs}B/${sellRecs}S/${holdRecs}H`;
                    document.getElementById('report-accuracy-overall').textContent = `${(agreementRate * 100).toFixed(0)}%`;
                    document.getElementById('report-accuracy-1h').textContent = totalSignals.toString();
                    document.getElementById('report-accuracy-eod').textContent = agreements.toString();
                }
            } catch (error) {
                console.error('Error loading RL shadow stats:', error);
            }
        }

        async function exportTrades(format) {
            try {
                const tradesData = await api('/api/trades');
                const trades = tradesData?.trades || [];

                if (trades.length === 0) {
                    alert('No trades to export');
                    return;
                }

                let content, filename, type;

                if (format === 'csv') {
                    const headers = ['ID', 'Timestamp', 'Symbol', 'Action', 'Quantity', 'Price', 'P&L', 'Strategy'];
                    const rows = trades.map(t => [
                        t.id || '',
                        t.timestamp || '',
                        t.symbol || '',
                        t.action || '',
                        t.quantity || '',
                        t.price || '',
                        t.pnl || '',
                        t.strategy || ''
                    ]);
                    content = [headers, ...rows].map(r => r.join(',')).join('\n');
                    filename = `trades_export_${new Date().toISOString().split('T')[0]}.csv`;
                    type = 'text/csv';
                } else {
                    content = JSON.stringify(trades, null, 2);
                    filename = `trades_export_${new Date().toISOString().split('T')[0]}.json`;
                    type = 'application/json';
                }

                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error exporting trades: ' + error.message);
            }
        }

        async function exportPredictions() {
            try {
                const rlShadow = await api('/api/rl-shadow');

                if (!rlShadow || !rlShadow.recommendations) {
                    alert('No RL Shadow data to export');
                    return;
                }

                const content = JSON.stringify(rlShadow, null, 2);
                const filename = `rl_shadow_export_${new Date().toISOString().split('T')[0]}.json`;

                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error exporting RL Shadow data: ' + error.message);
            }
        }

        async function loadRecentLogs() {
            const container = document.getElementById('system-logs');
            container.innerHTML = 'Loading activity...';

            try {
                // Load recent trades as activity log
                const tradesData = await api('/api/trades');
                const trades = tradesData?.trades || [];

                if (trades.length > 0) {
                    const recentTrades = trades.slice(0, 20);
                    container.innerHTML = recentTrades.map(t => {
                        const time = new Date(t.timestamp).toLocaleString();
                        const pnlStr = t.pnl ? (t.pnl >= 0 ? `+$${t.pnl.toFixed(2)}` : `-$${Math.abs(t.pnl).toFixed(2)}`) : '';
                        const color = t.action === 'BUY' ? 'var(--sage-green)' : 'var(--dusty-rose)';
                        const pnlColor = (t.pnl || 0) >= 0 ? 'var(--sage-green)' : 'var(--dusty-rose)';
                        return `<div style="padding: 4px 0; border-bottom: 1px solid var(--border-color);">
                            <span style="color: var(--text-muted);">${time}</span> -
                            <span style="color: ${color}; font-weight: bold;">${t.action}</span>
                            <span style="color: var(--text-primary);">${t.quantity} ${t.symbol}</span>
                            @ $${t.price?.toFixed(2) || '?'}
                            ${pnlStr ? `<span style="color: ${pnlColor}; margin-left: 10px;">${pnlStr}</span>` : ''}
                            <span style="color: var(--text-muted); font-size: 11px; margin-left: 10px;">(${t.strategy || 'N/A'})</span>
                        </div>`;
                    }).join('');
                } else {
                    container.innerHTML = '<p style="color: var(--text-muted);">No recent trading activity.</p>';
                }
            } catch (error) {
                container.innerHTML = `<p style="color: var(--text-muted);">Could not load activity: ${error.message}</p>`;
            }
        }

        // Period selector change handler
        document.getElementById('report-period')?.addEventListener('change', loadReportMetrics);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            startAutoRefresh();
            initBacktestDates();
            loadSettings();
            loadCurrentTradingMode();
        });
    </script>
</body>
</html>
